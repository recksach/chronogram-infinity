<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CHRONOGRAM DESKTOP</title>
    <link rel="icon" type="image1/jpeg" href="logo1.jpeg">
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        /* === THEME: TELEGRAM DESKTOP STYLE === */
        :root {
            --bg-master: #0e1621;       /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω —Å–ø–∏—Å–∫–∞ */
            --bg-detail: #17212b;       /* –§–æ–Ω —á–∞—Ç–∞/–ø—Ä–æ—Ñ–∏–ª—è */
            --hover: #202b36;           /* –ù–∞–≤–µ–¥–µ–Ω–∏–µ */
            --accent: #5288c1;          /* Telegram Blue */
            --text: #f5f5f5;
            --text-sec: #7f91a4;
            --border: 1px solid rgba(0,0,0,0.2);
            --msg-in: #182533;
            --msg-out: #2b5278;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Manrope', sans-serif; color: var(--text); background: #000; height: 100vh; overflow: hidden; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        /* –í–•–û–î */
        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #0e1621; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* –õ–ï–ô–ê–£–¢ (DESKTOP FIRST) */
        #app { display: none; width: 100%; height: 100%; background: var(--bg-master); }
        #app.active { display: flex; }

        /* –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–°–ü–ò–°–û–ö) */
        .sidebar {
            width: 350px; height: 100%; display: flex; flex-direction: column;
            border-right: 1px solid #000; background: var(--bg-master); flex-shrink: 0;
        }

        /* –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (–ß–ê–¢/–ü–†–û–§–ò–õ–¨) */
        .main-view {
            flex: 1; height: 100%; position: relative; background: #000;
            background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png'); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .main-view { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
                transform: translateX(100%); transition: transform 0.25s ease;
            }
            .main-view.active { transform: translateX(0); }
        }

        /* –ö–û–ú–ü–û–ù–ï–ù–¢–´ */
        .header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-master); border-bottom: var(--border); color: var(--text-sec);
        }
        .search-bar { padding: 10px; background: var(--bg-master); }
        .search-in { width: 100%; background: #242f3d; border: none; padding: 10px 15px; border-radius: 20px; color: white; }

        .tabs { display: flex; background: var(--bg-master); }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: var(--text-sec); font-weight: 600; font-size: 0.9rem; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .list-wrap { flex: 1; overflow-y: auto; }
        .list-item { 
            display: flex; align-items: center; gap: 12px; padding: 10px 15px; cursor: pointer; transition: 0.2s; 
        }
        .list-item:hover, .list-item.active { background: var(--hover); }
        
        .ava { width: 48px; height: 48px; border-radius: 50%; background: #2f3b4b; background-size: cover; background-position: center; flex-shrink: 0; }
        .ava-sq { border-radius: 12px; }

        /* –ß–ê–¢ */
        .chat-head {
            width: 100%; height: 60px; background: var(--bg-detail); border-bottom: var(--border);
            display: flex; align-items: center; padding: 0 20px; gap: 15px; cursor: pointer;
        }
        .chat-content { flex: 1; width: 100%; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .chat-input {
            width: 100%; min-height: 60px; background: var(--bg-detail); padding: 10px 20px;
            display: flex; align-items: center; gap: 15px;
        }
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--msg-out); color: white; }
        .msg.other { align-self: flex-start; background: var(--msg-in); color: white; }

        /* –ü–û–°–¢–´ –ö–ê–ù–ê–õ–ê */
        .post { width: 100%; max-width: 500px; align-self: center; background: var(--bg-detail); border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .post-img { width: 100%; max-height: 400px; object-fit: cover; display: block; }
        .post-body { padding: 15px; }
        .post-text { white-space: pre-wrap; margin-bottom: 10px; }
        .url-btn { display: block; background: rgba(82, 136, 193, 0.15); color: var(--accent); text-align: center; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: 600; }

        /* –ü–†–û–§–ò–õ–¨ (–í–°–¢–†–û–ï–ù–ù–´–ô) */
        .profile-view { width: 100%; height: 100%; background: var(--bg-master); display: flex; flex-direction: column; align-items: center; padding-top: 50px; overflow-y: auto; }
        .big-ava { width: 140px; height: 140px; border-radius: 50%; background-size: cover; margin-bottom: 20px; cursor: pointer; position: relative; }
        .big-ava:hover::after { content: '–ò–∑–º–µ–Ω–∏—Ç—å'; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); border-radius:50%; color:white; display:flex; justify-content:center; align-items:center; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; }
        .btn:hover { opacity: 0.9; }
        .btn-sec { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
        .btn-red { background: transparent; color: #ff5959; border: 1px solid #ff5959; }

        .icon { font-family: 'Material Symbols Rounded'; font-size: 24px; color: var(--text-sec); cursor: pointer; }
        .icon:hover { color: var(--text); }
        .badge-verif { display: inline-block; width: 16px; height: 16px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235288c1'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E") no-repeat center; vertical-align: middle; margin-left: 5px; }
        .badge-god::after { content: 'üëë'; margin-left: 5px; font-size: 1.1rem; vertical-align: middle; }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–ï */
        #toast { position: fixed; top: 20px; right: 20px; background: var(--accent); color: white; padding: 15px 25px; border-radius: 8px; z-index: 9999; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="auth-screen">
        <div class="app-logo-lg"></div>
        <h2 style="margin-bottom: 20px;">CHRONOGRAM</h2>
        <input type="email" id="email" placeholder="Email" style="padding:12px; border-radius:8px; border:none; background:#242f3d; color:white; margin-bottom:10px; width:280px;">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:12px; border-radius:8px; border:none; background:#242f3d; color:white; margin-bottom:10px; width:280px;">
        <input type="text" id="username" placeholder="Username" style="padding:12px; border-radius:8px; border:none; background:#242f3d; color:white; margin-bottom:20px; width:280px;">
        <button class="btn" onclick="Auth.go('login')" style="width:280px; margin-bottom:10px;">–í–æ–π—Ç–∏</button>
        <button class="btn btn-sec" onclick="Auth.go('reg')" style="width:280px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <p id="auth-err" style="color:#ff5959; margin-top:10px;"></p>
        <div onclick="localStorage.clear();location.reload()" style="margin-top:20px; color:#555; cursor:pointer; font-size:0.8rem;">–°–ë–†–û–°–ò–¢–¨ –ö–≠–®</div>
    </div>

    <div id="app">
        <div class="sidebar">
            <div class="header">
                <span class="icon" onclick="Nav.toProfile()">menu</span>
                <b style="color:white; letter-spacing:1px;">CHRONOGRAM</b>
                <span class="icon" onclick="Channels.createModal()">add_circle</span>
            </div>
            <div class="search-bar">
                <input type="text" class="search-in" id="search-in" placeholder="–ü–æ–∏—Å–∫..." oninput="Search.run()">
            </div>
            <div class="tabs">
                <div class="tab active" id="tab-chats" onclick="Nav.tab('chats')">–ß–∞—Ç—ã</div>
                <div class="tab" id="tab-channels" onclick="Nav.tab('channels')">–ö–∞–Ω–∞–ª—ã</div>
            </div>
            <div id="list-chats" class="list-wrap"></div>
            <div id="list-channels" class="list-wrap hidden"></div>
            <div id="list-search" class="list-wrap hidden"></div>
        </div>

        <div id="main-view" class="main-view">
            <div style="color:var(--text-sec); text-align:center;">
                <span class="icon" style="font-size:60px; opacity:0.5;">forum</span><br><br>
                –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –∫–∞–Ω–∞–ª<br>—á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
            </div>
        </div>
    </div>

    <script>
        // –ö–õ–Æ–ß–ò CHRONOGRAMNEW
        const firebaseConfig = {
            apiKey: "AIzaSyCEHTgXvVF7a-H_NxlRj77i46ueelJBGL0",
            authDomain: "chronogramnew.firebaseapp.com",
            projectId: "chronogramnew",
            storageBucket: "chronogramnew.firebasestorage.app",
            messagingSenderId: "1081606850128",
            appId: "1:1081606850128:web:439fd598a3d11576a47355"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let me = null;
        let isGod = false;
        let activeChat = null; // { id, type, name, ava, isG, isV }

        auth.onAuthStateChanged(user => {
            if(user) {
                me = user;
                if(Notification.permission !== "granted") Notification.requestPermission();
                db.collection('users').doc(me.uid).get().then(doc => {
                    if(doc.exists) {
                        if(doc.data().username === 'mrakodum') isGod = true;
                        document.getElementById('auth-screen').style.display='none';
                        document.getElementById('app').classList.add('active');
                        App.init();
                    } else auth.signOut();
                });
            } else {
                document.getElementById('auth-screen').style.display='flex';
                document.getElementById('app').classList.remove('active');
            }
        });

        const Auth = {
            go: (type) => {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                const u = document.getElementById('username').value.toLowerCase().trim();
                if(type === 'reg') {
                    if(!u) return alert('–ù–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    Promise.all([
                        db.collection('users').where('username','==',u).get(),
                        db.collection('channels').where('username','==',u).get()
                    ]).then(([s1,s2]) => {
                        if(!s1.empty || !s2.empty) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç');
                        auth.createUserWithEmailAndPassword(e,p).then(c=>{
                            db.collection('users').doc(c.user.uid).set({username:u, displayName:u, avatar:'', followers:[], following:[]});
                        });
                    });
                } else auth.signInWithEmailAndPassword(e,p).catch(e=>document.getElementById('auth-err').innerText=e.message);
            }
        };

        const App = { init: () => { Chats.load(); Channels.load(); Notify.listen(); } };

        const Nav = {
            tab: (t) => {
                document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
                document.getElementById('tab-'+t).classList.add('active');
                document.getElementById('list-chats').classList.add('hidden');
                document.getElementById('list-channels').classList.add('hidden');
                document.getElementById('list-search').classList.add('hidden');
                document.getElementById('list-'+t).classList.remove('hidden');
                document.getElementById('search-in').value = '';
            },
            back: () => {
                document.getElementById('main-view').classList.remove('active'); // –¢–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª–æ–∫
            },
            toProfile: () => {
                Profile.renderMe();
            }
        };

        // --- –°–ü–ò–°–ö–ò ---
        const Chats = {
            load: () => {
                db.collection('users').doc(me.uid).collection('chats').orderBy('time','desc').onSnapshot(s => {
                    const l = document.getElementById('list-chats'); l.innerHTML='';
                    s.forEach(doc => {
                        const d = doc.data();
                        db.collection('users').doc(doc.id).get().then(u => {
                            if(!u.exists) return;
                            const ud = u.data();
                            const act = activeChat && activeChat.id === doc.id ? 'active' : '';
                            l.innerHTML += `
                                <div class="list-item ${act}" onclick="Chat.open('${doc.id}', 'user', '${ud.displayName}', '${ud.avatar}', ${ud.username==='mrakodum'}, ${ud.verified})">
                                    <div class="ava" style="background-image:url('${ud.avatar||''}')"></div>
                                    <div style="flex:1; overflow:hidden;">
                                        <div style="font-weight:600;">${ud.displayName} ${Render.badges(ud.username==='mrakodum', ud.verified)}</div>
                                        <div style="font-size:0.9rem; color:#7f91a4; white-space:nowrap; text-overflow:ellipsis;">${d.lastMsg}</div>
                                    </div>
                                    ${d.unread ? '<div style="width:10px;height:10px;background:var(--accent);border-radius:50%"></div>' : ''}
                                </div>`;
                        });
                    });
                });
            }
        };

        const Channels = {
            createModal: () => {
                const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
                const slug = prompt('–Æ–∑–µ—Ä–Ω–µ–π–º (@news):');
                if(name && slug) {
                    const s = slug.replace('@','').toLowerCase();
                    Promise.all([
                        db.collection('users').where('username','==',s).get(),
                        db.collection('channels').where('username','==',s).get()
                    ]).then(([s1,s2])=>{
                        if(!s1.empty || !s2.empty) return alert('–ó–∞–Ω—è—Ç–æ');
                        db.collection('channels').add({name:name, username:s, owner:me.uid, subs:[me.uid], avatar:''});
                    });
                }
            },
            load: () => {
                db.collection('channels').where('subs', 'array-contains', me.uid).onSnapshot(s => {
                    const l = document.getElementById('list-channels'); l.innerHTML='';
                    s.forEach(doc => {
                        const c = doc.data();
                        const act = activeChat && activeChat.id === doc.id ? 'active' : '';
                        l.innerHTML += `
                            <div class="list-item ${act}" onclick="Chat.open('${doc.id}', 'channel', '${c.name}', '${c.avatar}', false, true)">
                                <div class="ava ava-sq" style="background-image:url('${c.avatar||''}')"></div>
                                <div style="flex:1;">
                                    <div style="font-weight:600;">${c.name} <span class="badge-verif"></span></div>
                                    <div style="font-size:0.9rem; color:#7f91a4;">@${c.username}</div>
                                </div>
                            </div>`;
                    });
                });
            }
        };

        const Search = {
            run: () => {
                const q = document.getElementById('search-in').value.toLowerCase();
                const l = document.getElementById('list-search');
                document.getElementById('list-chats').classList.add('hidden');
                document.getElementById('list-channels').classList.add('hidden');
                l.classList.remove('hidden');
                l.innerHTML = '';
                if(q.length<2) return;

                Promise.all([db.collection('users').get(), db.collection('channels').get()]).then(([us, cs]) => {
                    let res = [];
                    us.forEach(d => { if(d.data().username.includes(q)) res.push({...d.data(), id:d.id, type:'user'}); });
                    cs.forEach(d => { if(d.data().username.includes(q)) res.push({...d.data(), id:d.id, type:'channel'}); });
                    
                    res.sort((a,b) => (b.followers?.length||b.subs?.length||0) - (a.followers?.length||a.subs?.length||0));
                    
                    res.forEach(r => {
                        const isG = r.username==='mrakodum';
                        const isV = r.verified || r.type==='channel';
                        const cls = r.type==='channel' ? 'ava ava-sq' : 'ava';
                        l.innerHTML += `
                            <div class="list-item" onclick="Chat.open('${r.id}', '${r.type}', '${r.displayName||r.name}', '${r.avatar}', ${isG}, ${isV})">
                                <div class="${cls}" style="background-image:url('${r.avatar||''}')"></div>
                                <div><b>${r.displayName||r.name}</b> ${Render.badges(isG, isV)}<br><small>@${r.username}</small></div>
                            </div>`;
                    });
                });
            }
        };

        // --- –ß–ê–¢ / –û–°–ù–û–í–ù–û–ï –û–ö–ù–û ---
        const Chat = {
            open: (id, type, name, ava, isG, isV) => {
                activeChat = { id, type, name, ava, isG, isV };
                const mv = document.getElementById('main-view');
                mv.classList.add('active'); // –ú–æ–±–∏–ª–∫–∞
                
                // –†–µ–Ω–¥–µ—Ä –®–∞–ø–∫–∏
                mv.innerHTML = `
                    <div class="chat-head" onclick="Profile.renderOther('${id}', '${type}')">
                        <span class="icon" style="margin-right:10px;" onclick="event.stopPropagation(); Nav.back()">arrow_back</span>
                        <div class="ava ${type==='channel'?'ava-sq':''}" style="background-image:url('${ava||''}')"></div>
                        <div style="flex:1;">
                            <b>${name}</b> ${Render.badges(isG, isV)}
                            <div id="sub-stat" style="font-size:0.8rem; color:#7f91a4;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        <span class="icon">more_vert</span>
                    </div>
                    <div id="chat-msgs" class="chat-content"></div>
                    <div class="chat-input" id="chat-input">
                        <label class="icon"><input type="file" hidden onchange="Chat.upl(this)">attach_file</label>
                        <input id="msg-in" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." style="flex:1; background:transparent; border:none; color:white; font-size:1rem;">
                        <span class="icon" style="color:var(--accent);" onclick="Chat.send()">send</span>
                    </div>
                `;

                // –°—Ç–∞—Ç—É—Å/–ü–æ–¥–ø–∏—Å—á–∏–∫–∏
                if(type === 'channel') {
                    db.collection('channels').doc(id).onSnapshot(d => {
                        const c = d.data();
                        document.getElementById('sub-stat').innerText = c.subs.length + ' –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤';
                        if(c.owner !== me.uid && !isGod) document.getElementById('chat-input').style.display='none';
                    });
                } else {
                    document.getElementById('sub-stat').innerText = '–≤ —Å–µ—Ç–∏';
                    db.collection('users').doc(me.uid).collection('chats').doc(id).set({unread:false}, {merge:true});
                }

                // –°–æ–æ–±—â–µ–Ω–∏—è
                const col = type==='user' ? 'messages' : 'posts';
                const docId = type==='user' ? [me.uid, id].sort().join('_') : id;
                
                db.collection(col).doc(docId).collection('msg').orderBy('time').onSnapshot(s => {
                    const l = document.getElementById('chat-msgs'); l.innerHTML='';
                    s.forEach(d => {
                        const m = d.data();
                        const mine = m.uid === me.uid;
                        if(type==='channel') l.innerHTML += Chat.renderPost(m, d.id, isGod || mine);
                        else l.innerHTML += Chat.renderMsg(m, mine);
                    });
                    l.scrollTop = l.scrollHeight;
                });
            },
            send: (txt=null, type='text') => {
                const v = txt || document.getElementById('msg-in').value;
                if(!v) return;
                const col = activeChat.type==='user' ? 'messages' : 'posts';
                const docId = activeChat.type==='user' ? [me.uid, activeChat.id].sort().join('_') : activeChat.id;
                
                db.collection(col).doc(docId).collection('msg').add({
                    text: v, type: type, uid: me.uid, time: Date.now(), likes: [], views: 0, viewedBy: []
                });

                const last = type==='text' ? v : '–§–∞–π–ª';
                if(activeChat.type==='user') {
                    db.collection('users').doc(me.uid).collection('chats').doc(activeChat.id).set({lastMsg:last, time:Date.now()}, {merge:true});
                    db.collection('users').doc(activeChat.id).collection('chats').doc(me.uid).set({lastMsg:last, time:Date.now(), unread:true}, {merge:true});
                } else {
                    db.collection('channels').doc(activeChat.id).update({lastMsg:last, lastPostTime:Date.now()});
                }
                if(!txt) document.getElementById('msg-in').value='';
            },
            upl: (i) => {
                const f = i.files[0];
                storage.ref().child(`chat/${Date.now()}`).put(f).then(s=>s.ref.getDownloadURL()).then(u=>Chat.send(u, f.type.includes('image')?'image':'file'));
            },
            renderMsg: (m, mine) => {
                let c = m.text;
                if(m.type==='image') c = `<img src="${m.text}" style="max-width:100%; border-radius:8px;">`;
                return `<div class="msg ${mine?'me':'other'}">${c}</div>`;
            },
            renderPost: (m, id, admin) => {
                let btn = ''; const match = m.text.match(/\[(.*?)\s\+\s(.*?)\]/);
                let txt = m.text;
                if(match) { txt = txt.replace(match[0],''); btn=`<a href="${match[2]}" target="_blank" class="url-btn">${match[1]}</a>`; }
                let media = m.type==='image' ? `<img src="${m.text}" class="post-img">` : '';
                let del = admin ? `<span style="float:right; cursor:pointer; color:#ff5959;" onclick="Chat.del('${id}')">‚úï</span>` : '';
                const liked = m.likes && m.likes.includes(me.uid);
                return `<div class="post">
                    ${media}
                    <div class="post-body">
                        ${del} <div class="post-text">${txt}</div> ${btn}
                        <div style="margin-top:10px; display:flex; gap:15px; color:#7f91a4; font-size:0.9rem;">
                            <span onclick="Chat.like('${id}',${liked})" style="cursor:pointer; color:${liked?'#ff5959':'inherit'}">‚ù§Ô∏è ${m.likes?.length||0}</span>
                            <span>üëÅ ${m.views||0}</span>
                        </div>
                    </div>
                </div>`;
            },
            like: (pid, isL) => {
                const ref = db.collection('posts').doc(activeChat.id).collection('msg').doc(pid);
                ref.update({likes: isL ? firebase.firestore.FieldValue.arrayRemove(me.uid) : firebase.firestore.FieldValue.arrayUnion(me.uid)});
            },
            del: (pid) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.collection('posts').doc(activeChat.id).collection('msg').doc(pid).delete(); }
        };

        // --- –ü–†–û–§–ò–õ–¨ ---
        const Profile = {
            renderMe: () => {
                const mv = document.getElementById('main-view'); mv.classList.add('active');
                db.collection('users').doc(me.uid).get().then(d => {
                    const u = d.data();
                    mv.innerHTML = `
                        <div class="profile-view">
                            <span class="icon" style="align-self:flex-start; margin-left:20px;" onclick="Nav.back()">arrow_back</span>
                            <div class="big-ava" style="background-image:url('${u.avatar||''}')">
                                <input type="file" hidden onchange="Profile.updAva(this)" style="position:absolute; width:100%; height:100%; top:0; left:0; opacity:0; cursor:pointer;">
                            </div>
                            <h2 style="margin:0;">${u.displayName} ${Render.badges(isGod, u.verified)}</h2>
                            <div style="color:#7f91a4; margin-bottom:20px;">@${u.username}</div>
                            <div style="display:flex; gap:40px; margin-bottom:40px;">
                                <div style="text-align:center;"><b>${u.followers?.length||0}</b><br><span style="color:#7f91a4;">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</span></div>
                                <div style="text-align:center;"><b>${u.following?.length||0}</b><br><span style="color:#7f91a4;">–ü–æ–¥–ø–∏—Å–∫–∏</span></div>
                            </div>
                            <input id="edit-name" value="${u.displayName}" style="background:#242f3d; padding:10px; border:none; color:white; border-radius:8px; margin-bottom:10px;">
                            <button class="btn" onclick="Profile.saveName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
                            <br>
                            <button class="btn btn-red" onclick="auth.signOut()">–í—ã–π—Ç–∏</button>
                            ${isGod ? `<div style="margin-top:30px; border:1px solid gold; padding:15px; border-radius:10px;"><input id="god-u" placeholder="–ù–∏–∫"><br><button class="btn btn-gold" onclick="God.verify()">–ì–∞–ª–æ—á–∫–∞</button></div>` : ''}
                        </div>
                    `;
                });
            },
            renderOther: (id, type) => {
                const mv = document.getElementById('main-view'); mv.classList.add('active');
                const ref = type==='user' ? db.collection('users').doc(id) : db.collection('channels').doc(id);
                
                ref.get().then(doc => {
                    const d = doc.data();
                    const isSub = type==='user' ? (d.followers?.includes(me.uid)) : (d.subs?.includes(me.uid));
                    const btnTxt = isSub ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                    const btnCls = isSub ? 'btn-sec' : 'btn';
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–í–ê–¢–ê–†–ö–ò –ö–ê–ù–ê–õ–ê
                    const canEdit = (type==='channel' && (d.owner === me.uid || isGod));
                    const avaInput = canEdit ? `<input type="file" hidden onchange="Profile.updChanAva('${id}', this)" style="position:absolute;width:100%;height:100%;top:0;left:0;opacity:0;cursor:pointer;">` : '';
                    const avaHint = canEdit ? ' (–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å)' : '';

                    mv.innerHTML = `
                        <div class="profile-view">
                            <span class="icon" style="align-self:flex-start; margin-left:20px;" onclick="Chat.open('${id}','${type}','${d.displayName||d.name}','${d.avatar}', ${d.username==='mrakodum'}, ${d.verified||true})">arrow_back</span>
                            <div class="big-ava" style="background-image:url('${d.avatar||''}')">${avaInput}</div>
                            ${canEdit ? `<small style="color:#5288c1;">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ üëÜ</small>` : ''}
                            <h2 style="margin:10px 0;">${d.displayName||d.name}</h2>
                            <div style="color:#7f91a4; margin-bottom:20px;">@${d.username}</div>
                            <button class="${btnCls}" onclick="Profile.toggleSub('${id}','${type}', ${isSub})">${btnTxt}</button>
                            <br>
                            ${canEdit ? `<button class="btn btn-red" onclick="Channels.del('${id}')">–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª</button>` : ''}
                        </div>
                    `;
                });
            },
            updAva: (i) => {
                storage.ref().child(`ava/${me.uid}`).put(i.files[0]).then(s=>s.ref.getDownloadURL()).then(u=>{
                    db.collection('users').doc(me.uid).update({avatar:u}).then(Profile.renderMe);
                });
            },
            updChanAva: (id, i) => {
                storage.ref().child(`chan/${id}`).put(i.files[0]).then(s=>s.ref.getDownloadURL()).then(u=>{
                    db.collection('channels').doc(id).update({avatar:u}).then(() => Profile.renderOther(id, 'channel'));
                });
            },
            saveName: () => {
                db.collection('users').doc(me.uid).update({displayName: document.getElementById('edit-name').value}).then(()=>alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'));
            },
            toggleSub: (id, type, isSub) => {
                if(type === 'channel') {
                    db.collection('channels').doc(id).update({
                        subs: isSub ? firebase.firestore.FieldValue.arrayRemove(me.uid) : firebase.firestore.FieldValue.arrayUnion(me.uid)
                    }).then(() => Profile.renderOther(id, type));
                } else {
                    db.collection('users').doc(id).update({followers: isSub ? firebase.firestore.FieldValue.arrayRemove(me.uid) : firebase.firestore.FieldValue.arrayUnion(me.uid)});
                    db.collection('users').doc(me.uid).update({following: isSub ? firebase.firestore.FieldValue.arrayRemove(id) : firebase.firestore.FieldValue.arrayUnion(id)});
                    setTimeout(() => Profile.renderOther(id, type), 500);
                }
            }
        };

        const Notify = {
            listen: () => {
                db.collection('users').doc(me.uid).collection('chats').where('unread','==',true).onSnapshot(s => {
                    s.docChanges().forEach(c => { if(c.type==='modified') Notify.show('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', c.doc.data().lastMsg); });
                });
            },
            show: (t,b) => {
                const el = document.getElementById('toast');
                el.innerText = `${t}: ${b}`; el.style.display='block';
                setTimeout(()=>el.style.display='none', 3000);
            }
        };

        const Render = {
            badges: (g, v) => (v?'<span class="badge-verif"></span>':'') + (g?'<span class="badge-god"></span>':'')
        };

        const God = {
            verify: () => {
                const u = document.getElementById('god-u').value;
                db.collection('users').where('username','==',u).get().then(s => { s.forEach(d => d.ref.update({verified:true})); alert('OK'); });
            }
        };
        
        const Channels = {
            del: (id) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.collection('channels').doc(id).delete().then(()=>Nav.toProfile()); }
        };
    </script>
</body>
</html>
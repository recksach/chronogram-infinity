<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NET-LINK: BASE</title>
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <style>
        /* СТИЛЬ "ТЕРМИНАЛ" - НИЧЕГО ЛИШНЕГО */
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 20px; }
        
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; }
        
        input { 
            background: #000; border: 2px solid #0f0; color: #0f0; 
            padding: 10px; font-size: 1.2rem; margin-bottom: 20px; 
            text-align: center; width: 300px;
        }
        
        button { 
            background: #0f0; color: #000; border: none; 
            padding: 10px 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
        }
        button:hover { background: #fff; }

        .hidden { display: none; }

        /* ИНТЕРФЕЙС СВЯЗИ */
        #main-ui { display: flex; flex-direction: column; height: 95vh; }
        
        .header { border-bottom: 1px solid #0f0; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* СПИСОК ЮЗЕРОВ */
        #radar { 
            border: 1px solid #005500; padding: 10px; margin-bottom: 20px; 
            height: 150px; overflow-y: auto; background: #001100;
        }
        .user-dot { 
            padding: 5px; margin: 2px; border: 1px solid #0f0; 
            display: inline-block; cursor: pointer; 
        }
        .user-dot:hover { background: #0f0; color: #000; }
        .user-dot.active { background: #fff; color: #000; }

        /* ЧАТ */
        #chat-area { flex: 1; border: 1px solid #0f0; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #050505; }
        
        .msg { margin-bottom: 5px; }
        .msg b { color: #fff; }

        #status { font-size: 0.8rem; color: #555; }
        .online { color: #0f0; }
        .offline { color: #f00; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>NET-LINK // v1</h1>
        <p>УЗЕЛ СВЯЗИ БЕЗ РЕГИСТРАЦИИ</p>
        <input type="text" id="username" placeholder="ПРИДУМАЙ ПОЗЫВНОЙ">
        <button onclick="App.connect()">ВВОД</button>
        <p id="net-status">ПОИСК СПУТНИКОВ...</p>
    </div>

    <div id="main-ui" class="hidden">
        <div class="header">
            <span id="my-id">...</span>
            <button onclick="location.reload()" style="padding: 2px 10px; font-size: 0.8rem;">ОТКЛЮЧИТЬСЯ</button>
        </div>

        <div>РАДАР (КТО В СЕТИ):</div>
        <div id="radar">Ожидание сигнала...</div>

        <div id="chat-title" style="margin-top: 20px; border-bottom: 1px solid #333;">ОБЩИЙ ЭФИР</div>
        <div id="chat-area"></div>

        <div style="display: flex; gap: 10px;">
            <input type="text" id="msg-input" placeholder="Сообщение..." style="flex:1; margin:0; text-align: left;">
            <button onclick="Chat.send()">ОТПРАВИТЬ</button>
        </div>
    </div>

    <script>
        // === 1. МАКСИМАЛЬНОЕ КОЛИЧЕСТВО УЗЛОВ СВЯЗИ ===
        // Это список публичных серверов. Твой браузер подключится ко всем сразу.
        // Если хоть один работает - ты увидишь других людей.
        const PEERS = [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun',
            'https://gunjs.herokuapp.com/gun',
            'https://peer.wallie.io/gun',
            'https://plato.design/gun',
            'https://gun-us.herokuapp.com/gun'
        ];

        const gun = Gun({ peers: PEERS });
        let myName = "";
        let currentRoom = "global"; // По умолчанию общий чат

        // === ПРОВЕРКА СЕТИ ===
        setInterval(() => {
            // Проверяем, подключены ли мы к узлам
            const mesh = gun.back('opt.peers');
            const connected = Object.keys(mesh).filter(id => mesh[id].wire && mesh[id].wire.readyState === 1).length;
            
            const statusText = connected > 0 ? `СВЯЗЬ ЕСТЬ (УЗЛОВ: ${connected})` : "ПОИСК СЕТИ...";
            document.getElementById('net-status').innerText = statusText;
            document.getElementById('net-status').className = connected > 0 ? "online" : "offline";
        }, 1000);

        const App = {
            connect: () => {
                const name = document.getElementById('username').value.trim();
                if(!name) return alert("НУЖНО ИМЯ");
                
                myName = name;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                document.getElementById('my-id').innerText = "ПОЗЫВНОЙ: " + myName;

                // 1. ЗАПУСКАЕМ МАЯЧОК "Я ТУТ"
                // Каждые 3 секунды обновляем запись о себе, чтобы другие видели, что мы онлайн
                setInterval(() => {
                    gun.get('net_link_users_v2').get(myName).put({
                        name: myName,
                        time: Date.now()
                    });
                }, 3000);

                // 2. ВКЛЮЧАЕМ РАДАР
                Radar.scan();
                
                // 3. ПОДКЛЮЧАЕМСЯ К ОБЩЕМУ ЧАТУ
                Chat.join('global');
            }
        };

        const Radar = {
            scan: () => {
                // Слушаем список всех пользователей
                gun.get('net_link_users_v2').map().on((data, key) => {
                    if(!data || !data.name) return;
                    
                    // Если пользователь не обновлялся больше 10 секунд - считаем его оффлайн
                    if(Date.now() - data.time > 10000) {
                        const existing = document.getElementById('u-'+key);
                        if(existing) existing.remove();
                        return;
                    }

                    // Если это я - пропускаем
                    if(data.name === myName) return;

                    // Рисуем пользователя
                    let el = document.getElementById('u-'+key);
                    if(!el) {
                        el = document.createElement('div');
                        el.id = 'u-'+key;
                        el.className = 'user-dot';
                        el.innerText = `[ ${data.name} ]`;
                        // При клике - переходим в личный чат (упрощенно: создаем уникальную комнату)
                        el.onclick = () => Chat.joinPrivate(data.name);
                        document.getElementById('radar').appendChild(el);
                    }
                });
            }
        };

        const Chat = {
            join: (roomName) => {
                currentRoom = roomName;
                document.getElementById('chat-area').innerHTML = ''; // Очистка
                document.getElementById('chat-title').innerText = roomName === 'global' ? "ОБЩИЙ ЭФИР" : "ПРИВАТ: " + roomName;

                // Слушаем сообщения в этой комнате
                gun.get('net_link_chat_v2').get(roomName).map().on((msg, id) => {
                    if(!msg || !msg.text) return;
                    // Простая защита от дублей
                    if(document.getElementById(id)) return;
                    
                    const div = document.createElement('div');
                    div.id = id;
                    div.className = 'msg';
                    div.innerHTML = `<b>${msg.who}:</b> ${msg.text}`;
                    
                    const area = document.getElementById('chat-area');
                    area.appendChild(div);
                    area.scrollTop = area.scrollHeight; // Автоскролл
                });
            },
            
            joinPrivate: (otherUser) => {
                // Создаем уникальное имя комнаты для двоих (сортируем имена, чтобы у обоих было одинаково)
                const room = [myName, otherUser].sort().join('_');
                Chat.join(room);
            },

            send: () => {
                const inp = document.getElementById('msg-input');
                const txt = inp.value;
                if(!txt) return;

                const msgId = Date.now() + Math.random().toString(36).substr(2, 5);
                
                gun.get('net_link_chat_v2').get(currentRoom).set({
                    who: myName,
                    text: txt,
                    time: Date.now()
                });
                
                inp.value = '';
            }
        };
    </script>
</body>
</html>
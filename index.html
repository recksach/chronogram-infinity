<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CHRONOGRAM X</title>
    <link rel="icon" type="image1/jpeg" href="logo1.jpg">
    <link rel="apple-touch-icon" href="logo1.jpg">
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        /* === THEME: GLOBAL UNIQUE === */
        :root {
            --bg: #050510;
            --header: rgba(15, 20, 28, 0.98);
            --accent: #2979FF;
            --gold: #FFD700;
            --text: #ffffff;
            --text-sec: #8aa0b6;
            --incoming: #1f2633;
            --outgoing: #2979FF;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Manrope', sans-serif; 
            color: var(--text); background: var(--bg);
            height: 100dvh; overflow: hidden;
        }

        body::before {
            content: ''; position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;
            background: radial-gradient(circle at 50% 50%, #0f1525 0%, #000 100%);
            pointer-events: none;
        }

        .icon { font-family: 'Material Symbols Rounded'; font-size: 24px; vertical-align: middle; }

        /* –í–•–û–î */
        #auth-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .app-logo-lg {
            width: 130px; height: 130px; border-radius: 50%;
            background-image: url('logo1.jpg'); background-size: cover; background-position: center;
            box-shadow: 0 0 50px rgba(41, 121, 255, 0.3); margin-bottom: 30px;
        }

        /* –õ–ï–ô–ê–£–¢ */
        #app { display: none; height: 100%; width: 100%; flex-direction: column; }
        #app.active { display: flex; }

        /* HEADER */
        .main-header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; background: var(--header); border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; z-index: 100;
        }

        /* TABS */
        .tabs { display: flex; background: var(--header); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tab { flex: 1; text-align: center; padding: 15px 0; color: var(--text-sec); cursor: pointer; position: relative; font-weight: 600; }
        .tab.active { color: var(--accent); }
        .tab.active::after { content:''; position:absolute; bottom:0; left:10%; width:80%; height:3px; background:var(--accent); border-radius:3px 3px 0 0; }

        /* –°–¢–†–ê–ù–ò–¶–´ */
        .pages-container { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; top:0; left:0; width:100%; height:100%; overflow-y: auto; display: none; padding-bottom: 80px; }
        .page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* –°–ü–ò–°–ö–ò */
        .list-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer;
        }
        .list-item:active { background: rgba(255,255,255,0.05); }
        .ava { width: 50px; height: 50px; border-radius: 50%; background: #333; background-size: cover; background-position: center; flex-shrink: 0; position: relative; }
        .ava-sq { border-radius: 14px; } 
        .badge-god::after { content: 'üëë'; margin-left: 5px; }
        .badge-verif { display: inline-block; width: 14px; height: 14px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232979FF'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E") no-repeat center; margin-left: 4px; vertical-align: middle; }

        /* –ß–ê–¢ */
        #chat-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050510; z-index: 2000; display: none; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #chat-screen.open { display: flex; transform: translateX(0); }

        .chat-header {
            height: 60px; background: var(--header); display: flex; align-items: center;
            padding: 0 10px; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://www.transparenttextures.com/patterns/dark-matter.png'); }

        .msg { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--outgoing); color: white; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--incoming); color: white; border-bottom-left-radius: 2px; }
        
        .channel-post {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 0; overflow: hidden; margin-bottom: 15px; width: 100%; max-width: 100%; align-self: center; position: relative;
        }
        .post-media { width: 100%; max-height: 400px; object-fit: cover; display: block; }
        .post-content { padding: 15px; }
        .post-text { white-space: pre-wrap; margin-bottom: 10px; }
        
        .anim-text {
            background: linear-gradient(90deg, #fff, #2979FF, #fff); background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite; font-weight: 600;
        }
        @keyframes shine { to { background-position: 200% center; } }

        .url-btn {
            display: block; width: 100%; padding: 12px; background: rgba(41, 121, 255, 0.15);
            color: var(--accent); text-align: center; border-radius: 10px; text-decoration: none;
            font-weight: 700; margin-top: 8px; border: 1px solid rgba(41, 121, 255, 0.3);
        }

        .input-bar {
            min-height: 60px; background: var(--header); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; padding: 10px; gap: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        input { flex: 1; background: rgba(0,0,0,0.3); border: none; padding: 12px; border-radius: 20px; color: white; font-size: 1rem; }
        .action-btn { color: var(--accent); cursor: pointer; padding: 8px; }

        .btn { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 700; width: 100%; margin-top: 10px; }
        .btn-sec { background: rgba(255,255,255,0.1); }
        .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA000); color: black; }
        .btn-danger { background: #FF3B30; color: white; }
        .video-circle { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }

        .del-btn {
            position: absolute; top: -10px; right: -10px; 
            width: 24px; height: 24px; background: #FF3B30; color: white; 
            border-radius: 50%; text-align: center; line-height: 24px; 
            font-size: 14px; cursor: pointer; border: 2px solid #000; z-index: 10;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="app-logo-lg"></div>
        <h2 style="margin-bottom: 30px;">CHRONOGRAM X</h2>
        <div style="width: 280px; text-align: center;">
            <input type="email" id="email" placeholder="Email" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; border:1px solid #333; background:#111; color:white;">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; border:1px solid #333; background:#111; color:white;">
            <input type="text" id="username" placeholder="Username (Eng)" style="width:100%; margin-bottom:10px; padding:12px; border-radius:12px; border:1px solid #333; background:#111; color:white;">
            <button class="btn" onclick="Auth.go('login')">–í–û–ô–¢–ò</button>
            <button class="btn btn-sec" onclick="Auth.go('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
            <p id="auth-err" style="color:#FF3B30; margin-top:15px; font-size:0.8rem;"></p>
            <div onclick="localStorage.clear();location.reload()" style="margin-top:40px; color:#555; cursor:pointer; text-decoration:underline;">–°–ë–†–û–° –ë–ê–ó–´</div>
        </div>
    </div>

    <div id="app">
        <div class="main-header">
            <div>CHRONOGRAM</div>
            <div style="display:flex; gap:15px;">
                <span class="icon" onclick="Nav.to('search')">search</span>
                <span class="icon" onclick="Nav.to('profile')">person</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="Nav.tab('chats')" id="tab-chats">–ß–ê–¢–´</div>
            <div class="tab" onclick="Nav.tab('channels')" id="tab-channels">–ö–ê–ù–ê–õ–´</div>
        </div>

        <div class="pages-container">
            <div id="pg-chats" class="page active"><div id="list-chats"></div></div>

            <div id="pg-channels" class="page">
                <div style="padding:15px;">
                    <button class="btn btn-sec" onclick="Channels.createModal()" style="margin-bottom:15px;">+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                    <div id="list-channels"></div>
                </div>
            </div>

            <div id="pg-search" class="page">
                <div style="padding:15px;">
                    <input type="text" id="search-in" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="Search.run()" style="width:100%;">
                    <div id="search-res" style="margin-top:15px;"></div>
                </div>
            </div>

            <div id="pg-profile" class="page">
                <div style="padding:40px 20px; text-align:center;">
                    <div id="my-ava" class="ava" style="width:100px; height:100px; margin:0 auto 20px;"></div>
                    <label class="btn btn-sec" style="display:inline-block; width:auto; padding:8px 20px; margin-bottom:20px;">
                        –§–æ—Ç–æ <input type="file" hidden accept="image/*" onchange="Profile.ava(this)">
                    </label>
                    <h2 id="my-name" style="margin:0;">Name</h2>
                    <div id="my-tag" style="color:var(--text-sec); margin-bottom:30px;">@tag</div>
                    
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; text-align:left; margin-bottom:30px;">
                        <input id="edit-name" placeholder="–ù–æ–≤–æ–µ –∏–º—è" style="background:transparent; border-bottom:1px solid #333; border-radius:0; padding:10px 0;">
                        <button class="btn btn-small" onclick="Profile.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>

                    <div id="god-panel" class="hidden" style="border:1px solid var(--gold); padding:15px; border-radius:16px; margin-bottom:30px; background:rgba(255, 215, 0, 0.05);">
                        <h4 style="color:var(--gold); margin:0 0 10px;">üëë GOD MODE</h4>
                        <input id="god-in" placeholder="–ù–∏–∫–Ω–µ–π–º —Ü–µ–ª–∏" style="background:#111; margin-bottom:10px;">
                        <div style="display:flex; flex-wrap:wrap; gap:10px;">
                            <button class="btn btn-gold" style="margin:0; flex:1;" onclick="God.verify()">–ì–∞–ª–æ—á–∫–∞</button>
                            <button class="btn btn-danger" style="margin:0; flex:1;" onclick="God.forceSubMe()">–ù–∞ –º–µ–Ω—è</button>
                        </div>
                    </div>

                    <button class="btn btn-sec" onclick="auth.signOut()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-header">
            <div style="padding:10px; cursor:pointer;" onclick="Chat.close()"><span class="icon">arrow_back</span></div>
            <div id="chat-ava" class="ava" style="width:40px; height:40px;"></div>
            <div style="flex:1;">
                <b id="chat-name">Name</b>
                <div id="chat-subs" style="font-size:0.8rem; color:var(--text-sec);"></div>
            </div>
            <div id="chan-settings-btn" class="icon hidden" onclick="Channels.settings()" style="cursor:pointer;">settings</div>
            <div id="chat-info-btn" class="icon" onclick="Chat.info()" style="margin-left:10px; cursor:pointer;">info</div>
        </div>

        <div id="chat-msgs" class="chat-body"></div>

        <div id="chat-input-area" class="input-bar">
            <label class="action-btn"><span class="icon">attach_file</span><input type="file" hidden onchange="Chat.sendFile(this)"></label>
            <input type="text" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div class="action-btn" onclick="Chat.send()"><span class="icon">send</span></div>
            <div class="action-btn" onmousedown="Media.start()" onmouseup="Media.stop()" ontouchstart="Media.start()" ontouchend="Media.stop()"><span class="icon">radio_button_checked</span></div>
        </div>
    </div>

    <div id="subs-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; display:none; flex-direction:column;">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; background:#111;">
            <b id="modal-title">–ò–Ω—Ñ–æ</b>
            <span class="icon" onclick="document.getElementById('subs-modal').style.display='none'">close</span>
        </div>
        <div id="subs-content" style="flex:1; overflow-y:auto; padding:15px;"></div>
    </div>

    <div id="camera-ui" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:5000; display:none;">
        <video id="cam-video" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; transform:scaleX(-1);"></video>
        <div style="position:absolute; bottom:50px; left:0; width:100%; display:flex; justify-content:center;">
            <div style="width:80px; height:80px; border:5px solid white; border-radius:50%; display:flex; justify-content:center; align-items:center;">
                <div style="width:60px; height:60px; background:red; border-radius:50%;"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEHTgXvVF7a-H_NxlRj77i46ueelJBGL0",
            authDomain: "chronogramnew.firebaseapp.com",
            projectId: "chronogramnew",
            storageBucket: "chronogramnew.firebasestorage.app",
            messagingSenderId: "1081606850128",
            appId: "1:1081606850128:web:439fd598a3d11576a47355"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let me = null;
        let isGod = false;
        let activeChat = null; 
        let recorder, chunks = [];

        auth.onAuthStateChanged(user => {
            if(user) {
                me = user;
                db.collection('users').doc(me.uid).get().then(doc => {
                    if(doc.exists) {
                        if(doc.data().username === 'mrakodum') {
                            isGod = true;
                            document.getElementById('god-panel').classList.remove('hidden');
                        }
                        document.getElementById('auth-screen').style.display='none';
                        document.getElementById('app').classList.add('active');
                        App.init();
                    } else auth.signOut();
                });
            } else {
                document.getElementById('auth-screen').style.display='flex';
                document.getElementById('app').classList.remove('active');
            }
        });

        const Auth = {
            go: (type) => {
                const e = document.getElementById('email').value;
                const p = document.getElementById('password').value;
                const u = document.getElementById('username').value.toLowerCase().trim();
                if(type === 'reg') {
                    if(!u) return alert('–ù—É–∂–µ–Ω –Ω–∏–∫');
                    // –ü–†–û–í–ï–†–ö–ê –í–ï–ó–î–ï (–ò –í –Æ–ó–ï–†–ê–•, –ò –í –ö–ê–ù–ê–õ–ê–•)
                    Promise.all([
                        db.collection('users').where('username','==',u).get(),
                        db.collection('channels').where('username','==',u).get()
                    ]).then(([s1, s2]) => {
                        if(!s1.empty || !s2.empty) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç (–∫–µ–º-—Ç–æ –∏–ª–∏ –∫–∞–Ω–∞–ª–æ–º)');
                        auth.createUserWithEmailAndPassword(e,p).then(c => {
                            db.collection('users').doc(c.user.uid).set({
                                username:u, displayName:u, avatar:'', followers:[], following:[]
                            });
                        });
                    });
                } else auth.signInWithEmailAndPassword(e,p).catch(e=>alert(e.message));
            }
        };

        const App = { init: () => { Profile.load(); Chats.load(); Channels.load(); } };

        const Nav = {
            to: (page) => {
                document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
                document.getElementById('pg-'+page).classList.add('active');
            },
            tab: (tab) => {
                document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                document.getElementById('tab-'+tab).classList.add('active');
                Nav.to(tab);
            }
        };

        const Chats = {
            load: () => {
                db.collection('users').doc(me.uid).collection('chats').orderBy('time','desc').onSnapshot(snap => {
                    const l = document.getElementById('list-chats'); l.innerHTML='';
                    snap.forEach(doc => {
                        const d = doc.data();
                        db.collection('users').doc(doc.id).get().then(u => {
                            const ud = u.data();
                            l.innerHTML += `
                                <div class="list-item" onclick="Chat.open('${doc.id}', 'user', '${ud.displayName}', '${ud.avatar}')">
                                    <div class="ava" style="background-image:url('${ud.avatar||''}')"></div>
                                    <div style="flex:1;">
                                        <b>${ud.displayName}</b> ${ud.verified?'<span class="badge-verif"></span>':''}
                                        <div style="font-size:0.9rem; color:var(--text-sec);">${d.lastMsg}</div>
                                    </div>
                                    ${d.unread ? '<div style="width:10px;height:10px;background:var(--accent);border-radius:50%"></div>' : ''}
                                </div>
                            `;
                        });
                    });
                });
            }
        };

        const Channels = {
            createModal: () => {
                const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
                const slug = prompt('–Æ–∑–µ—Ä–Ω–µ–π–º (@news):');
                if(name && slug) {
                    const s = slug.replace('@','').toLowerCase().trim();
                    // –ü–†–û–í–ï–†–ö–ê –í–ï–ó–î–ï
                    Promise.all([
                        db.collection('users').where('username','==',s).get(),
                        db.collection('channels').where('username','==',s).get()
                    ]).then(([snap1, snap2]) => {
                        if(!snap1.empty || !snap2.empty) return alert('–≠—Ç–æ—Ç –∞–¥—Ä–µ—Å –∑–∞–Ω—è—Ç!');
                        db.collection('channels').add({
                            name: name, username: s, owner: me.uid, subs: [me.uid], avatar: ''
                        });
                    });
                }
            },
            load: () => {
                db.collection('channels').where('subs', 'array-contains', me.uid).onSnapshot(snap => {
                    const l = document.getElementById('list-channels'); l.innerHTML='';
                    snap.forEach(doc => {
                        const c = doc.data();
                        l.innerHTML += `
                            <div class="list-item" onclick="Chat.open('${doc.id}', 'channel', '${c.name}', '${c.avatar}')">
                                <div class="ava ava-sq" style="background-image:url('${c.avatar||''}')"></div>
                                <div style="flex:1;">
                                    <b>${c.name}</b>
                                    <div style="font-size:0.9rem; color:var(--text-sec);">@${c.username}</div>
                                </div>
                            </div>
                        `;
                    });
                });
            },
            settings: () => {
                document.getElementById('subs-modal').style.display='flex';
                document.getElementById('modal-title').innerText = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–∞–Ω–∞–ª–∞';
                const l = document.getElementById('subs-content');
                l.innerHTML = `
                    <div style="text-align:center;">
                        <button class="btn" onclick="Channels.editAva()">–°–º–µ–Ω–∏—Ç—å –ê–≤–∞—Ç–∞—Ä–∫—É</button>
                        <button class="btn btn-sec" onclick="Channels.editName()">–ò–∑–º–µ–Ω–∏—Ç—å –ù–∞–∑–≤–∞–Ω–∏–µ</button>
                        <hr style="border:1px solid #333; margin:20px 0;">
                        <button class="btn btn-danger" onclick="Channels.delete()">–£–î–ê–õ–ò–¢–¨ –ö–ê–ù–ê–õ</button>
                    </div>
                `;
            },
            editName: () => {
                const n = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:');
                if(n) db.collection('channels').doc(activeChat.id).update({name:n});
            },
            editAva: () => {
                const i = document.createElement('input'); i.type='file'; i.accept='image/*'; i.click();
                i.onchange = e => {
                    const f = e.target.files[0];
                    storage.ref().child(`chan/${activeChat.id}`).put(f).then(s=>s.ref.getDownloadURL()).then(u=>{
                        db.collection('channels').doc(activeChat.id).update({avatar:u});
                    });
                }
            },
            delete: () => {
                if(confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
                    db.collection('channels').doc(activeChat.id).delete();
                    document.getElementById('subs-modal').style.display='none';
                    Chat.close();
                }
            }
        };

        const Chat = {
            open: (id, type, name, ava) => {
                activeChat = { id, type };
                document.getElementById('chat-screen').classList.add('open');
                document.getElementById('chat-name').innerText = name;
                document.getElementById('chat-ava').style.backgroundImage = ava ? `url('${ava}')` : '';
                document.getElementById('chat-ava').className = type==='channel' ? 'ava ava-sq' : 'ava';
                
                const settingsBtn = document.getElementById('chan-settings-btn');
                settingsBtn.classList.add('hidden');

                if(type === 'channel') {
                    db.collection('channels').doc(id).get().then(doc => {
                        const c = doc.data();
                        document.getElementById('chat-subs').innerText = c.subs.length + ' –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤';
                        if(c.owner === me.uid || isGod) {
                            document.getElementById('chat-input-area').style.display='flex';
                            settingsBtn.classList.remove('hidden');
                        } else {
                            document.getElementById('chat-input-area').style.display='none';
                        }
                    });
                } else {
                    document.getElementById('chat-subs').innerText = '—á–∞—Ç';
                    document.getElementById('chat-input-area').style.display='flex';
                    db.collection('users').doc(me.uid).collection('chats').doc(id).set({unread:false}, {merge:true});
                }

                const collId = type==='user' ? [me.uid, id].sort().join('_') : id;
                const collName = type==='user' ? 'messages' : 'posts';
                
                db.collection(collName).doc(collId).collection('msg').orderBy('time').onSnapshot(snap => {
                    const l = document.getElementById('chat-msgs'); l.innerHTML='';
                    snap.forEach(doc => {
                        const m = doc.data();
                        const canDelete = isGod || m.uid === me.uid;
                        const delBtn = canDelete ? `<div class="del-btn" onclick="Chat.deleteMsg('${collName}', '${collId}', '${doc.id}')">‚úï</div>` : '';

                        if(type === 'channel') l.innerHTML += Chat.renderPost(m, doc.id, delBtn);
                        else l.innerHTML += Chat.renderMsg(m, delBtn);
                    });
                    l.scrollTop = l.scrollHeight;
                });
            },
            close: () => {
                document.getElementById('chat-screen').classList.remove('open');
                activeChat = null;
            },
            send: (text=null, type='text') => {
                const inp = document.getElementById('msg-in');
                const txt = text || inp.value;
                if(!txt) return;

                const collId = activeChat.type==='user' ? [me.uid, activeChat.id].sort().join('_') : activeChat.id;
                const collName = activeChat.type==='user' ? 'messages' : 'posts';

                db.collection(collName).doc(collId).collection('msg').add({
                    text: txt, type: type, uid: me.uid, time: Date.now(), likes: 0
                });

                if(activeChat.type === 'user') {
                    const last = type==='text' ? txt : '–í–ª–æ–∂–µ–Ω–∏–µ';
                    db.collection('users').doc(me.uid).collection('chats').doc(activeChat.id).set({lastMsg:last, time:Date.now()}, {merge:true});
                    db.collection('users').doc(activeChat.id).collection('chats').doc(me.uid).set({lastMsg:last, time:Date.now(), unread:true}, {merge:true});
                }
                inp.value='';
            },
            sendFile: (inp) => {
                const f = inp.files[0];
                if(f.size > 50*1024*1024) return alert('–§–∞–π–ª > 50 –ú–ë');
                const ref = storage.ref().child(`files/${Date.now()}`);
                ref.put(f).then(s=>s.ref.getDownloadURL()).then(url => {
                    Chat.send(url, f.type.includes('image')?'image':'file');
                });
            },
            deleteMsg: (coll, docId, msgId) => {
                if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.collection(coll).doc(docId).collection('msg').doc(msgId).delete();
            },
            renderMsg: (m, delBtn) => {
                let content = m.text;
                if(m.type==='image') content = `<img src="${m.text}" style="max-width:100%; border-radius:10px;">`;
                if(m.type==='circle') content = `<video src="${m.text}" class="video-circle" autoplay loop muted></video>`;
                if(m.type==='file') content = `<a href="${m.text}" target="_blank" style="color:white;">üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
                return `<div class="msg ${m.uid===me.uid?'me':'other'}">${delBtn} ${content}</div>`;
            },
            renderPost: (m, id, delBtn) => {
                let body = m.text;
                let btnHtml = '';
                const btnMatch = body.match(/\[(.*?)\s\+\s(.*?)\]/);
                if(btnMatch) {
                    body = body.replace(btnMatch[0], ''); 
                    btnHtml = `<a href="${btnMatch[2]}" target="_blank" class="url-btn">${btnMatch[1]}</a>`;
                }
                let mediaHtml = '';
                if(m.type === 'image') mediaHtml = `<img src="${m.text}" class="post-media">`;
                if(m.type === 'circle') mediaHtml = `<div style="padding:15px; text-align:center;"><video src="${m.text}" class="video-circle" autoplay loop muted></video></div>`;
                
                return `<div class="channel-post">
                    ${delBtn}
                    ${mediaHtml}
                    <div class="post-content">
                        <div class="post-text anim-text">${body}</div>
                        ${btnHtml}
                        <div class="reactions"><div class="react-btn" onclick="Chat.like('${id}')">‚ù§Ô∏è ${m.likes||0}</div></div>
                    </div>
                </div>`;
            },
            like: (postId) => {
                if(activeChat.type !== 'channel') return;
                db.collection('posts').doc(activeChat.id).collection('msg').doc(postId).update({ likes: firebase.firestore.FieldValue.increment(1) });
            },
            info: () => {
                if(activeChat.type !== 'channel') return;
                document.getElementById('subs-modal').style.display='flex';
                const l = document.getElementById('subs-content');
                l.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                db.collection('channels').doc(activeChat.id).get().then(doc => {
                    const subs = doc.data().subs;
                    l.innerHTML = '';
                    subs.forEach(uid => {
                        db.collection('users').doc(uid).get().then(u => {
                            const ud = u.data();
                            l.innerHTML += `<div class="list-item"><div class="ava" style="background-image:url('${ud.avatar}')"></div><b>${ud.displayName}</b></div>`;
                        });
                    });
                });
            }
        };

        const Search = {
            run: () => {
                const q = document.getElementById('search-in').value.toLowerCase();
                if(q.length<3) return;
                db.collection('users').get().then(snap => {
                    const l = document.getElementById('search-res'); l.innerHTML='';
                    snap.forEach(doc => {
                        const d = doc.data();
                        if(d.username.includes(q)) l.innerHTML += `<div class="list-item" onclick="Chat.open('${doc.id}', 'user', '${d.displayName}', '${d.avatar}')"><div class="ava" style="background-image:url('${d.avatar}')"></div><b>${d.displayName}</b></div>`;
                    });
                });
                db.collection('channels').get().then(snap => {
                    snap.forEach(doc => {
                        const d = doc.data();
                        if(d.username.includes(q)) document.getElementById('search-res').innerHTML += `<div class="list-item" onclick="Chat.open('${doc.id}', 'channel', '${d.name}', '${d.avatar}')"><div class="ava ava-sq" style="background-image:url('${d.avatar}')"></div><b>${d.name}</b></div>`;
                    });
                });
            }
        };

        const Profile = {
            load: () => {
                db.collection('users').doc(me.uid).onSnapshot(doc => {
                    const d = doc.data();
                    document.getElementById('my-name').innerText = d.displayName;
                    document.getElementById('my-tag').innerText = '@'+d.username;
                    document.getElementById('edit-name').value = d.displayName;
                    document.getElementById('my-ava').style.backgroundImage = `url('${d.avatar||''}')`;
                });
            },
            save: () => {
                db.collection('users').doc(me.uid).update({displayName: document.getElementById('edit-name').value});
                alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            },
            ava: (inp) => {
                const f = inp.files[0];
                storage.ref().child(`ava/${me.uid}`).put(f).then(s=>s.ref.getDownloadURL()).then(u=>{
                    db.collection('users').doc(me.uid).update({avatar:u});
                });
            }
        };

        const Media = {
            start: () => {
                document.getElementById('camera-ui').style.display='block';
                navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(s=>{
                    document.getElementById('cam-video').srcObject = s;
                    recorder = new MediaRecorder(s);
                    chunks=[];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = Media.upl;
                    recorder.start();
                });
            },
            stop: () => {
                recorder.stop();
                document.getElementById('camera-ui').style.display='none';
                const t = document.getElementById('cam-video').srcObject.getTracks();
                t.forEach(track=>track.stop());
            },
            upl: () => {
                const b = new Blob(chunks, {type:'video/webm'});
                storage.ref().child(`circ/${Date.now()}`).put(b).then(s=>s.ref.getDownloadURL()).then(u=>{
                    Chat.send(u, 'circle');
                });
            }
        };

        const God = {
            verify: () => {
                const u = document.getElementById('god-in').value;
                db.collection('users').where('username','==',u).get().then(s=>{
                    s.forEach(d=>d.ref.update({verified:true}));
                    alert('–ì–∞–ª–æ—á–∫–∞ –≤—ã–¥–∞–Ω–∞');
                });
            },
            forceSubMe: () => {
                const u = document.getElementById('god-in').value;
                db.collection('users').where('username','==',u).get().then(snap => {
                    if(snap.empty) return alert('–Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    snap.forEach(target => {
                        db.collection('users').doc(target.id).update({
                            following: firebase.firestore.FieldValue.arrayUnion(me.uid)
                        });
                        db.collection('users').doc(me.uid).update({
                            followers: firebase.firestore.FieldValue.arrayUnion(target.id)
                        });
                        alert('–¢–µ–ø–µ—Ä—å –æ–Ω –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –≤–∞—Å!');
                    });
                });
            }
        };

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHRONOGRAM: OMEGA</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>

    <style>
        /* === OMEGA GOLD THEME === */
        :root {
            --bg: #000000;
            --gold: #FFD700;
            --blue: #1DA1F2;
            --glass: rgba(18, 18, 18, 0.98);
            --border: 1px solid #333;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }

        /* –í–•–û–î */
        #gate { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
        }
        .logo-ring {
            width: 100px; height: 100px; border: 3px solid var(--gold); border-radius: 50%; 
            margin-bottom: 20px; background-image: url('image_1.png'); background-size: cover;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .app { display: none; height: 100%; width: 100%; flex-direction: column; }
        .app.active { display: flex; }

        .main-area { flex: 1; overflow-y: auto; background: var(--glass); position: relative; scroll-behavior: smooth; }
        .page { display: none; padding: 15px; flex-direction: column; align-items: center; padding-bottom: 80px; }
        .page.active { display: flex; }
        .container { width: 100%; max-width: 500px; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            height: 60px; border-top: var(--border); background: #000;
            display: flex; justify-content: space-around; align-items: center; flex-shrink: 0;
        }
        .nav-btn { font-size: 1.6rem; color: #555; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: var(--gold); transform: scale(1.1); text-shadow: 0 0 10px var(--gold); }

        @media (min-width: 769px) {
            .app { flex-direction: row; }
            .nav { width: 80px; height: 100%; flex-direction: column; border-top: none; border-right: var(--border); justify-content: center; gap: 40px; }
        }

        /* UI –≠–õ–ï–ú–ï–ù–¢–´ */
        .card { background: #111; border: 1px solid #333; border-radius: 15px; padding: 15px; margin-bottom: 15px; width: 100%; }
        
        .btn { 
            background: var(--gold); color: #000; font-weight: 800; border: none; 
            padding: 12px; border-radius: 30px; width: 100%; cursor: pointer; margin-top: 10px;
        }
        
        input, textarea { 
            width: 100%; background: #222; border: 1px solid #444; color: white; 
            padding: 12px; border-radius: 10px; margin-bottom: 10px; font-family: inherit;
        }

        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #333; background-size: cover; background-position: center; border: 1px solid var(--gold); flex-shrink: 0; }
        
        .verified { color: var(--blue); margin-left: 5px; font-size: 0.9rem; }
        .verified::after { content: '‚úî'; }

        /* –°–û–¶–ò–ê–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò */
        .actions { display: flex; gap: 20px; margin-top: 10px; border-top: 1px solid #222; padding-top: 10px; }
        .act-btn { cursor: pointer; color: #888; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .act-btn:hover { color: var(--gold); }
        .act-btn.liked { color: red; }

        /* –ú–û–î–ê–õ–ö–ò (–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò / –ê–í–ê–¢–ê–†) */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 5000; display: none; 
            flex-direction: column; 
        }
        .modal-head { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        .modal-foot { padding: 15px; border-top: 1px solid #333; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="gate">
        <div class="logo-ring"></div>
        <h2 style="color:var(--gold); margin-bottom:20px;">CHRONOGRAM</h2>
        <div style="width: 280px; text-align: center;">
            <input type="text" id="log-u" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="log-p" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="Auth.login()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
            <p id="status" style="color:#666; font-size:0.8rem; margin-top:10px;"></p>
            <button onclick="localStorage.clear();location.reload()" style="background:transparent; border:none; color:red; margin-top:30px; cursor:pointer; text-decoration:underline;">–°–ë–†–û–°–ò–¢–¨ –ë–ê–ó–£ (–ï–°–õ–ò –ó–ê–í–ò–°–õ–û)</button>
        </div>
    </div>

    <div id="app" class="app">
        <div class="nav">
            <div class="nav-btn active" onclick="Nav.go('feed')">‚ò∑</div>
            <div class="nav-btn" onclick="Nav.go('search')">üîç</div>
            <div class="nav-btn" onclick="Nav.go('chats')">üí¨</div>
            <div class="nav-btn" onclick="Nav.go('profile')">üë§</div>
        </div>

        <div class="main-area">
            <div id="pg-feed" class="page active">
                <div class="container">
                    <div class="card">
                        <textarea id="post-text" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" style="min-height:60px;"></textarea>
                        <div style="display:flex; justify-content:space-between;">
                            <label class="btn" style="width:auto; padding:10px 15px; background:#333; color:#fff;">
                                üì∑ <input type="file" hidden onchange="Feed.preview(this)">
                            </label>
                            <button class="btn" style="width:auto;" onclick="Feed.send()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
                        </div>
                        <div id="file-prev" style="font-size:0.8rem; color:#888; margin-top:5px;"></div>
                    </div>
                    <div id="feed-list"></div>
                </div>
            </div>

            <div id="pg-search" class="page">
                <div class="container">
                    <h3>–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –°–ï–¢–¨</h3>
                    <input type="text" id="search-in" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." oninput="Search.run()">
                    <div id="users-list"></div>
                </div>
            </div>

            <div id="pg-chats" class="page">
                <div class="container">
                    <h3>–î–ò–ê–õ–û–ì–ò</h3>
                    <div id="chat-list"></div>
                </div>
            </div>

            <div id="pg-profile" class="page">
                <div class="container">
                    <div class="card" style="text-align:center;">
                        <div id="prof-ava" style="width:100px; height:100px; border-radius:50%; border:2px solid var(--gold); margin:0 auto; background-size:cover; background-position:center;"></div>
                        <label class="btn" style="width:auto; padding:5px 15px; font-size:0.8rem; background:#333; color:#fff; display:inline-block; margin-top:10px;">
                            –ò–ó–ú–ï–ù–ò–¢–¨ –§–û–¢–û
                            <input type="file" hidden accept="image/*" onchange="Profile.upload(this)">
                        </label>
                        
                        <h2 style="margin:10px 0;">
                            <span id="prof-name">@...</span>
                            <span id="prof-badge" class="hidden verified"></span>
                        </h2>

                        <div style="display:flex; justify-content:center; gap:20px; color:#888; margin-bottom:20px;">
                            <div><b id="cnt-followers" style="color:white;">0</b><br>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                            <div><b id="cnt-following" style="color:white;">0</b><br>–ü–æ–¥–ø–∏—Å–∫–∏</div>
                        </div>

                        <div id="admin-panel" class="hidden" style="border:1px solid red; padding:10px; margin-top:10px; border-radius:10px;">
                            <h4 style="color:red; margin:0;">MRAKODUM TOOLS</h4>
                            <input type="text" id="adm-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
                            <button class="btn" onclick="Admin.verify()">–í–´–î–ê–¢–¨ –ì–ê–õ–û–ß–ö–£</button>
                            <button class="btn" style="background:#500;" onclick="Admin.ban()">–ó–ê–ë–ê–ù–ò–¢–¨</button>
                        </div>

                        <button class="btn" style="background:#333; margin-top:20px;" onclick="Auth.logout()">–í–´–ô–¢–ò</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-comments" class="modal">
        <div class="modal-head">
            <span style="color:var(--gold);">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
            <button class="btn" style="width:auto; margin:0; padding:5px 10px;" onclick="Comments.close()">X</button>
        </div>
        <div id="comments-list" class="modal-body"></div>
        <div class="modal-foot" style="display:flex; gap:10px;">
            <input type="text" id="comm-in" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." style="margin:0;">
            <button class="btn" style="width:auto; margin:0;" onclick="Comments.send()">></button>
        </div>
    </div>

    <div id="modal-chat" class="modal">
        <div class="modal-head">
            <span id="chat-title" style="color:var(--gold);">–ß–∞—Ç</span>
            <button class="btn" style="width:auto; margin:0; padding:5px 10px;" onclick="Chat.close()">X</button>
        </div>
        <div id="chat-msgs" class="modal-body" style="display:flex; flex-direction:column; gap:10px;"></div>
        <div class="modal-foot" style="display:flex; gap:10px;">
            <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
            <button class="btn" style="width:auto; margin:0;" onclick="Chat.send()">></button>
        </div>
    </div>

    <script>
        // === 1. –ú–û–©–ù–ê–Ø –°–ï–¢–¨ (20 –£–ó–õ–û–í) ===
        const PEERS = [
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun',
            'https://gunjs.herokuapp.com/gun',
            'https://e2eec.herokuapp.com/gun',
            'https://gun-us.herokuapp.com/gun',
            'https://peer.wallie.io/gun',
            'https://plato.design/gun'
        ];

        const gun = Gun({ peers: PEERS, localStorage: true });
        const user = gun.user();
        let myUser = null;
        let myPub = null;

        // –ê–≤—Ç–æ-–≤—Ö–æ–¥
        user.recall({sessionStorage: true});
        gun.on('auth', () => {
            user.get('alias').once(u => {
                myUser = u; 
                myPub = user.is.pub;
                // –ó–ê–ü–ò–°–¨ –í –ì–õ–û–ë–ê–õ–¨–ù–£–Æ –ö–ù–ò–ì–£ (–ß–¢–û–ë–´ –ù–ê–•–û–î–ò–õ–û)
                gun.get('global_users_33').get(u).put({name: u, pub: myPub});
                
                document.getElementById('gate').style.display='none';
                document.getElementById('app').classList.add('active');
                App.init();
            });
        });

        const Auth = {
            login: () => {
                const u = document.getElementById('log-u').value.toLowerCase();
                const p = document.getElementById('log-p').value;
                if(!u || !p) return;
                
                document.getElementById('status').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏...";
                user.create(u, p, ack => {
                    user.auth(u, p, ack2 => {
                        if(ack2.err) alert(ack2.err);
                    });
                });
            },
            logout: () => { user.leave(); location.reload(); }
        };

        const App = {
            init: () => {
                // –ê–¥–º–∏–Ω–∫–∞
                if(myUser === 'mrakodum') {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    gun.get('badges').get(myUser).put(true); // –°–µ–±–µ –≥–∞–ª–æ—á–∫—É
                }
                
                Profile.init();
                Feed.init();
                Search.init(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª—é–¥–µ–π —Å—Ä–∞–∑—É
                Chat.loadList();
            }
        };

        // === 2. –ü–†–û–§–ò–õ–¨, –ì–ê–õ–û–ß–ö–ê, –ü–û–î–ü–ò–°–ß–ò–ö–ò ===
        const Profile = {
            init: () => {
                document.getElementById('prof-name').innerText = '@' + myUser;
                // –ê–≤–∞—Ç–∞—Ä–∫–∞
                user.get('avatar').on(src => {
                    if(src) {
                        document.getElementById('prof-ava').style.backgroundImage = `url('${src}')`;
                    }
                });
                // –ì–∞–ª–æ—á–∫–∞
                gun.get('badges').get(myUser).on(val => {
                    if(val) document.getElementById('prof-badge').classList.remove('hidden');
                });
                // –ü–æ–¥—Å—á–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                gun.get('followers').get(myUser).map().on((val, key) => {
                    // –ü—Ä–æ—Å—Ç–∞—è —ç–º—É–ª—è—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
                    let count = 0; // –¢—É—Ç –Ω—É–∂–µ–Ω —Å–ª–æ–∂–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç, –ø–æ–∫–∞ —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                });
            },
            upload: (inp) => {
                const f = inp.files[0];
                const r = new FileReader();
                r.onload = e => user.get('avatar').put(e.target.result);
                r.readAsDataURL(f);
            }
        };

        // === 3. –õ–ï–ù–¢–ê, –õ–ê–ô–ö–ò, –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò ===
        const Feed = {
            temp: null,
            preview: (inp) => {
                const f = inp.files[0];
                const r = new FileReader();
                r.onload = e => { Feed.temp = e.target.result; document.getElementById('file-prev').innerText = "–§–∞–π–ª –≥–æ—Ç–æ–≤"; };
                r.readAsDataURL(f);
            },
            send: () => {
                const t = document.getElementById('post-text').value;
                if(!t && !Feed.temp) return;
                const id = 'post_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                gun.get('posts_omega').get(id).put({
                    text: t, author: myUser, media: Feed.temp, time: Date.now(), id: id
                });
                document.getElementById('post-text').value = ''; Feed.temp = null;
            },
            init: () => {
                gun.get('posts_omega').map().on(p => {
                    if(!p || !p.text) return;
                    if(document.getElementById(p.id)) return;
                    if(localStorage.getItem('ban_'+p.author)) return;

                    let media = p.media ? `<img src="${p.media}" style="width:100%; border-radius:10px; margin-top:10px;">` : '';
                    if(p.media && p.media.includes('video')) media = `<video src="${p.media}" controls style="width:100%"></video>`;

                    const html = `
                    <div class="card" id="${p.id}">
                        <div style="display:flex; justify-content:space-between;">
                            <b style="color:var(--gold)">@${p.author}</b>
                            <small style="color:#555">${new Date(p.time).toLocaleTimeString()}</small>
                        </div>
                        <div style="margin-top:5px;">${p.text}</div>
                        ${media}
                        <div class="actions">
                            <div class="act-btn" onclick="Actions.like('${p.id}')">‚ù§Ô∏è <span id="l-${p.id}">0</span></div>
                            <div class="act-btn" onclick="Comments.open('${p.id}')">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                        </div>
                    </div>`;
                    
                    document.getElementById('feed-list').insertAdjacentHTML('afterbegin', html);
                    
                    // –°–ª—É—à–∞–µ–º –ª–∞–π–∫–∏
                    gun.get('likes').get(p.id).map().on((val, key) => {
                        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
                    });
                });
            }
        };

        const Actions = {
            like: (pid) => {
                gun.get('likes').get(pid).get(myUser).put(true);
                // –í–∏–∑—É–∞–ª—å–Ω–æ +1
                const el = document.getElementById('l-'+pid);
                el.innerText = parseInt(el.innerText) + 1;
                el.style.color = 'red';
            }
        };

        const Comments = {
            activePost: null,
            open: (pid) => {
                Comments.activePost = pid;
                document.getElementById('modal-comments').style.display = 'flex';
                document.getElementById('comments-list').innerHTML = '';
                
                gun.get('comments').get(pid).map().on(c => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.innerHTML = `<b style="color:var(--gold)">@${c.auth}</b>: ${c.text}`;
                    document.getElementById('comments-list').appendChild(div);
                });
            },
            send: () => {
                const t = document.getElementById('comm-in').value;
                if(!t) return;
                gun.get('comments').get(Comments.activePost).set({text: t, auth: myUser, time: Date.now()});
                document.getElementById('comm-in').value = '';
            },
            close: () => document.getElementById('modal-comments').style.display = 'none'
        };

        // === 4. –ü–û–ò–°–ö –ò –õ–Æ–î–ò ===
        const Search = {
            init: () => {
                gun.get('global_users_33').map().on(u => {
                    if(!u || !u.name) return;
                    if(document.getElementById('u-'+u.name)) return;
                    
                    // –†–µ–Ω–¥–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫
                    const div = document.createElement('div');
                    div.id = 'u-'+u.name;
                    div.className = 'card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>@${u.name}</b>
                            <div style="display:flex; gap:10px;">
                                <button class="btn" style="width:auto; margin:0; font-size:0.7rem; padding:5px 10px;" onclick="Search.follow('${u.name}')">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                                <button class="btn" style="width:auto; margin:0; font-size:0.7rem; padding:5px 10px; background:#333;" onclick="Chat.open('${u.pub}', '${u.name}')">–ß–∞—Ç</button>
                            </div>
                        </div>`;
                    document.getElementById('users-list').appendChild(div);
                });
            },
            run: () => {
                const q = document.getElementById('search-in').value.toLowerCase();
                const list = document.getElementById('users-list').children;
                for(let el of list) {
                    el.style.display = el.id.includes(q) ? 'block' : 'none';
                }
            },
            follow: (nick) => {
                gun.get('followers').get(nick).get(myUser).put(true);
                gun.get('following').get(myUser).get(nick).put(true);
                alert(`–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ @${nick}`);
                document.getElementById('cnt-following').innerText = parseInt(document.getElementById('cnt-following').innerText) + 1;
            }
        };

        // === 5. –ß–ê–¢ ===
        const Chat = {
            activePub: null,
            open: (pub, name) => {
                Chat.activePub = pub;
                document.getElementById('modal-chat').style.display = 'flex';
                document.getElementById('chat-title').innerText = name;
                document.getElementById('chat-msgs').innerHTML = '';
                
                const k = [user.is.pub, pub].sort().join('_');
                gun.get('chat_'+k).map().on(m => {
                    const div = document.createElement('div');
                    const me = m.auth === myUser;
                    div.style.alignSelf = me ? 'flex-end' : 'flex-start';
                    div.style.background = me ? 'var(--gold)' : '#333';
                    div.style.color = me ? 'black' : 'white';
                    div.style.padding = '8px 12px'; div.style.borderRadius = '10px';
                    div.innerText = m.text;
                    document.getElementById('chat-msgs').appendChild(div);
                });
                
                user.get('my_chats').get(pub).put(name); // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
            },
            send: () => {
                const t = document.getElementById('chat-in').value;
                if(!t) return;
                const k = [user.is.pub, Chat.activePub].sort().join('_');
                gun.get('chat_'+k).set({text: t, auth: myUser, time: Date.now()});
                document.getElementById('chat-in').value = '';
            },
            close: () => document.getElementById('modal-chat').style.display = 'none',
            loadList: () => {
                user.get('my_chats').map().on((name, pub) => {
                    if(!document.getElementById('c-'+pub)) {
                        document.getElementById('chat-list').innerHTML += `<div id="c-${pub}" class="card" onclick="Chat.open('${pub}','${name}')"><b>${name}</b></div>`;
                    }
                });
            }
        };

        const Admin = {
            verify: () => {
                const n = document.getElementById('adm-nick').value;
                gun.get('badges').get(n).put(true);
                alert("–ì–∞–ª–æ—á–∫–∞ –≤—ã–¥–∞–Ω–∞!");
            },
            ban: () => {
                const n = document.getElementById('adm-nick').value;
                localStorage.setItem('ban_'+n, true);
                alert("–ó–∞–±–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.");
            }
        };

        const Nav = { go: (id) => { document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('pg-'+id).classList.add('active'); }};
    </script>
</body>
</html>
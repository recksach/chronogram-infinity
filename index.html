<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHRONOGRAM: INFINITY</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>

    <style>
        /* === LUXURY VISUALS === */
        :root {
            --bg: #050505;
            --gold: #D4AF37;
            --gold-light: #f1c40f;
            --gold-grad: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7);
            --glass: rgba(20, 20, 20, 0.6);
            --glass-border: 1px solid rgba(212, 175, 55, 0.3);
            --neon-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Montserrat'; height: 100vh; overflow: hidden; }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
        #dust-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        /* === –ò–ù–¢–ï–†–§–ï–ô–° === */
        .app-layout { display: flex; height: 100%; width: 100%; backdrop-filter: blur(5px); }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar { 
            width: 80px; background: rgba(0,0,0,0.8); border-right: var(--glass-border); 
            display: flex; flex-direction: column; align-items: center; padding-top: 30px; z-index: 50;
            transition: 0.3s;
        }
        
        .nav-item { 
            width: 50px; height: 50px; border-radius: 15px; margin-bottom: 25px; 
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem; 
            color: #666; cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .nav-item:hover { color: var(--gold-light); background: rgba(255,255,255,0.05); transform: scale(1.1); }
        .nav-item.active { 
            color: #000; background: var(--gold-grad); 
            box-shadow: 0 0 20px var(--gold); transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .app-layout { flex-direction: column; }
            .sidebar { 
                width: 100%; height: 70px; flex-direction: row; justify-content: space-around; 
                border-right: none; border-top: var(--glass-border); padding: 0; 
                position: absolute; bottom: 0; background: #000;
            }
            .nav-item { margin-bottom: 0; width: 45px; height: 45px; font-size: 1.2rem; }
            .main { height: calc(100% - 70px) !important; }
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; overflow: hidden; }
        
        .top-bar { 
            height: 70px; border-bottom: var(--glass-border); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 30px; background: rgba(0,0,0,0.6); 
        }
        .brand { font-family: 'Cinzel'; color: var(--gold); font-weight: bold; font-size: 1.5rem; letter-spacing: 2px; text-shadow: 0 0 10px rgba(212,175,55,0.5); }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { 
            flex: 1; overflow-y: auto; padding: 20px; display: none; 
            flex-direction: column; align-items: center; padding-bottom: 100px;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { width: 100%; max-width: 600px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .card { 
            background: rgba(30, 30, 30, 0.7); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 20px; padding: 20px; margin-bottom: 20px; 
            backdrop-filter: blur(10px); transition: 0.3s;
        }
        .card:hover { border-color: var(--gold); box-shadow: var(--neon-shadow); }

        .btn { 
            background: var(--gold-grad); border: none; padding: 12px 25px; border-radius: 30px; 
            font-weight: bold; cursor: pointer; color: #000; font-family: 'Cinzel'; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.3s; width: 100%; margin-top: 10px;
        }
        .btn:active { transform: scale(0.95); }
        
        input, textarea { 
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; 
            padding: 15px; border-radius: 15px; margin-bottom: 10px; font-family: 'Montserrat'; font-size: 1rem; 
            transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--gold); outline: none; box-shadow: var(--neon-shadow); }

        .avatar { 
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); 
            background-size: cover; background-position: center; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; color: var(--gold); background: #111; flex-shrink: 0;
        }

        /* Badge */
        .badge-god { color: var(--gold); text-shadow: 0 0 5px var(--gold); margin-left: 5px; }
        .badge-blue { color: #00a8ff; text-shadow: 0 0 5px #00a8ff; margin-left: 5px; }

        /* –í—Ö–æ–¥ */
        #auth-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .logo-big { 
            width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--gold); 
            margin-bottom: 30px; background-image: url('image_1.png'); background-size: cover; 
            box-shadow: 0 0 30px var(--gold); animation: pulse 3s infinite; 
        }

        /* Chat */
        .chat-row { display: flex; align-items: center; cursor: pointer; padding: 10px; border-radius: 15px; transition: 0.2s; }
        .chat-row:hover { background: rgba(255,255,255,0.05); }
        .chat-last-msg { color: #888; font-size: 0.8rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px; }

        /* –†–µ–¥–∞–∫—Ç–æ—Ä */
        #editor-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 2000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        
        /* –†–µ–∫–ª–∞–º–∞ */
        #ad-modal { position: fixed; bottom: 20px; right: 20px; width: 300px; background: rgba(20,0,0,0.95); border: 2px solid red; padding: 20px; border-radius: 15px; z-index: 9999; animation: slideIn 0.5s; display: none; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .hidden { display: none !important; }
        @keyframes pulse { 50% { opacity: 0.7; transform: scale(0.98); } }
    </style>
</head>
<body>

    <canvas id="dust-canvas"></canvas>

    <div id="auth-screen">
        <div class="logo-big"></div>
        <h1 style="font-family:'Cinzel'; color:var(--gold); margin-bottom:40px; letter-spacing: 5px;">CHRONOGRAM<br><span style="font-size:1rem; color:white;">INFINITY</span></h1>
        <div style="width: 280px; text-align: center;">
            <input type="text" id="auth-user" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ Username" style="text-align:center;">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="text-align:center;">
            <button class="btn" onclick="App.login()">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
            <p id="auth-status" style="color:#666; font-size:0.8rem; margin-top:15px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–º —É–∑–ª–∞–º...</p>
        </div>
    </div>

    <div id="editor-modal" class="hidden">
        <h3 style="color:var(--gold);">ZOOM & CROP</h3>
        <div style="width:250px; height:250px; border:3px solid var(--gold); border-radius:50%; overflow:hidden; position:relative; background:#000;">
            <img id="edit-img" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); transition:transform 0.1s;">
        </div>
        <input type="range" id="zoom-range" min="0.5" max="3" step="0.1" value="1" style="width:200px; margin:20px 0;" oninput="Profile.zoom(this.value)">
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#333; color:white; width:auto;" onclick="document.getElementById('editor-modal').classList.add('hidden')">–û–¢–ú–ï–ù–ê</button>
            <button class="btn" style="width:auto;" onclick="Profile.saveAvatar()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
    </div>

    <div id="ad-modal">
        <h3 style="color:red; margin:0 0 10px 0;">–û–ë–™–Ø–í–õ–ï–ù–ò–ï</h3>
        <p id="ad-text" style="color:white;"></p>
        <button class="btn" style="padding:5px; font-size:0.7rem;" onclick="document.getElementById('ad-modal').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <div id="app-ui" class="app-layout hidden">
        <div class="sidebar">
            <div class="nav-item active" onclick="Nav.go('feed')" title="–õ–µ–Ω—Ç–∞">‚ò∑</div>
            <div class="nav-item" onclick="Nav.go('search')" title="–ü–æ–∏—Å–∫">üîç</div>
            <div class="nav-item" onclick="Nav.go('aura')" title="Aura" style="color:#e056fd;">‚óé</div>
            <div class="nav-item" onclick="Nav.go('chats')" title="–ß–∞—Ç—ã">üí¨</div>
            <div class="nav-item" onclick="Nav.go('music')" title="–ú—É–∑—ã–∫–∞">‚ô´</div>
            <div class="nav-item" onclick="Nav.go('profile')" title="–ü—Ä–æ—Ñ–∏–ª—å">üë§</div>
        </div>

        <div class="main">
            <div class="top-bar">
                <div class="brand">CHRONOGRAM</div>
                <div class="avatar" id="head-ava" onclick="Nav.go('profile')"></div>
            </div>

            <div id="pg-feed" class="page active">
                <div class="container">
                    <div class="card">
                        <textarea id="post-text" placeholder="–¢—Ä–∞–Ω—Å–ª–∏—Ä—É–π—Ç–µ –º—ã—Å–ª–∏..."></textarea>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <label class="btn" style="width:auto; background:transparent; border:1px solid var(--gold); color:var(--gold); padding:5px 15px;">
                                üìé <input type="file" hidden onchange="Feed.attach(this)">
                            </label>
                            <span id="file-name" style="font-size:0.7rem; color:#888;"></span>
                            <button class="btn" style="width:auto;" onclick="Feed.post('feed')">POST</button>
                        </div>
                    </div>
                    <div id="feed-list"></div>
                </div>
            </div>

            <div id="pg-search" class="page">
                <div class="container">
                    <h3 style="color:var(--gold); text-align:center;">–ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö</h3>
                    <div class="card" style="display:flex; gap:10px;">
                        <input type="text" id="search-input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="margin:0;">
                        <button class="btn" style="width:auto; margin:0;" onclick="Search.run()">‚Üí</button>
                    </div>
                    <div id="search-res"></div>
                    
                    <h3 style="margin-top:30px; text-align:center;">–ö–ê–ù–ê–õ–´</h3>
                    <div class="card" style="display:flex; gap:10px;">
                        <input type="text" id="chan-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞" style="margin:0;">
                        <button class="btn" style="width:auto; margin:0;" onclick="Channels.create()">+</button>
                    </div>
                    <div id="channels-list"></div>
                </div>
            </div>

            <div id="pg-aura" class="page" style="padding:0; background:#000;">
                <div style="position:absolute; top:20px; right:20px; z-index:100;">
                    <label class="btn" style="padding:10px 15px; background:rgba(0,0,0,0.5); border:1px solid white; color:white;">
                        + <input type="file" hidden onchange="Aura.upload(this)">
                    </label>
                </div>
                <div id="aura-feed"></div>
            </div>

            <div id="pg-chats" class="page">
                <div class="container">
                    <h3 style="color:var(--gold); text-align:center;">–î–ò–ê–õ–û–ì–ò</h3>
                    <div id="chat-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <div id="chat-room" class="page" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:60; display:none;">
                <div class="top-bar" style="background:#111;">
                    <span id="chat-name" style="font-weight:bold;">User</span>
                    <button class="btn" style="width:auto; padding:5px 15px; font-size:0.7rem;" onclick="Chat.close()">–ù–ê–ó–ê–î</button>
                </div>
                <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
                <div style="padding:15px; background:#111; display:flex; gap:10px;">
                    <input type="text" id="chat-input" placeholder="..." style="margin:0;">
                    <button class="btn" style="width:auto; margin:0;" onclick="Chat.send()">></button>
                </div>
            </div>

            <div id="pg-music" class="page">
                <div class="container">
                    <div class="card" style="text-align:center;">
                        <div class="avatar" style="width:80px; height:80px; margin:0 auto 15px auto; font-size:2rem;">‚ô´</div>
                        <h3 id="player-track">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫</h3>
                        <audio id="audio-player" controls style="width:100%; margin-top:10px; filter:sepia(1);"></audio>
                    </div>
                    <div id="music-list"></div>
                    <div style="text-align:center; margin-top:20px;">
                        <label class="btn">+ –¢–†–ï–ö <input type="file" hidden accept="audio/*" onchange="Music.upload(this)"></label>
                    </div>
                </div>
            </div>

            <div id="pg-profile" class="page">
                <div class="container">
                    <div class="card" style="text-align:center;">
                        <div class="avatar" id="profile-ava" style="width:120px; height:120px; margin:0 auto; font-size:3rem; cursor:pointer;" onclick="document.getElementById('ava-inp').click()"></div>
                        <input type="file" id="ava-inp" hidden onchange="Profile.initEdit(this)">
                        
                        <h2 style="margin:10px 0;">
                            <span id="profile-nick">@User</span>
                            <span id="badge-god" class="badge-god hidden">‚ôõ</span>
                            <span id="badge-verif" class="badge-blue hidden">‚úî</span>
                        </h2>
                        
                        <div id="admin-panel" class="hidden" style="border:1px solid red; padding:10px; margin-top:10px; border-radius:10px;">
                            <h4 style="color:red; margin:0;">GOD MODE</h4>
                            <input type="text" id="adm-target" placeholder="–¶–µ–ª—å (@username)">
                            <div style="display:flex; gap:5px;">
                                <button class="btn" style="font-size:0.7rem;" onclick="Admin.verify()">–ì–ê–õ–û–ß–ö–ê</button>
                                <button class="btn" style="font-size:0.7rem; background:#500;" onclick="Admin.forceSub()">–ü–†–ò–ù–£–î–ò–¢–¨</button>
                            </div>
                            <button class="btn" style="background:#d35400; font-size:0.7rem;" onclick="Admin.ad()">–†–ï–ö–õ–ê–ú–ê –í–°–ï–ú</button>
                        </div>

                        <div style="display:flex; justify-content:center; gap:20px; margin-top:15px; color:#888;">
                            <div onclick="Profile.showSubs('followers')">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: <b id="cnt-sub" style="color:white">0</b></div>
                            <div onclick="Profile.showSubs('following')">–ü–æ–¥–ø–∏—Å–∫–∏: <b id="cnt-ing" style="color:white">0</b></div>
                        </div>
                    </div>
                    <div id="subs-list"></div>
                    <button class="btn" style="background:#333;" onclick="location.reload()">–í–´–ô–¢–ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === GUN.JS INIT (P2P –°–ï–¢–¨) ===
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://gun-eu.herokuapp.com/gun']);
        const user = gun.user();
        let myUser = null;
        let currentChat = null;

        // === VISUALS (GOLD DUST) ===
        const cvs = document.getElementById('dust-canvas'), ctx = cvs.getContext('2d');
        cvs.width = window.innerWidth; cvs.height = window.innerHeight;
        const particles = [];
        for(let i=0; i<50; i++) particles.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, s:Math.random()*2, d:Math.random()});
        function anim() {
            ctx.clearRect(0,0,cvs.width,cvs.height);
            ctx.fillStyle = '#D4AF37';
            particles.forEach(p => {
                p.y -= p.s; if(p.y<0) p.y=cvs.height;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(anim);
        }
        anim();

        // === APP LOGIC ===
        const App = {
            login: () => {
                const u = document.getElementById('auth-user').value.toLowerCase();
                const p = document.getElementById('auth-pass').value;
                if(!u || !p) return;
                user.create(u, p, (ack) => {
                    if(ack.err && ack.err.indexOf('published') === -1) alert(ack.err); // –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –∑–∞–Ω—è—Ç–æ –∏ –ø–∞—Ä–æ–ª—å –Ω–µ —Ç–æ—Ç
                    user.auth(u, p, () => {
                        myUser = u;
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –≤ –ø—É–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞
                        gun.get('global_users').get(u).put({name: u, pub: user.is.pub});
                        // –ü—Ä–∞–≤–∞ –±–æ–≥–∞
                        if(u === 'mrakodum') user.get('profile').put({isAdmin: true, verified: true});
                        
                        document.getElementById('auth-screen').style.display='none';
                        document.getElementById('app-ui').classList.remove('hidden');
                        App.start();
                    });
                });
            },
            start: () => {
                Profile.load();
                Feed.load();
                Chat.loadList();
                Aura.load();
                Music.load();
                Channels.load();
                Admin.listenAds();
            }
        };

        // === FEED & AURA ===
        const Feed = {
            file: null,
            attach: async (inp) => {
                const f = inp.files[0]; if(!f) return;
                Feed.file = await Utils.toBase64(f);
                document.getElementById('file-name').innerText = "–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω";
            },
            post: (type) => {
                const txt = document.getElementById('post-text').value;
                if(!txt && !Feed.file) return;
                const data = {
                    text: txt, media: Feed.file, type: type, 
                    author: myUser, time: Date.now()
                };
                gun.get('posts_v1').set(data);
                if(type==='feed') document.getElementById('post-text').value='';
                Feed.file = null; document.getElementById('file-name').innerText='';
            },
            load: () => {
                gun.get('posts_v1').map().on(p => {
                    if(!p || p.type !== 'feed') return;
                    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π
                    if(document.getElementById(p.time)) return;
                    
                    const html = `
                    <div class="card" id="${p.time}">
                        <b>@${p.author}</b>
                        <div style="margin:10px 0;">${p.text}</div>
                        ${p.media ? (p.media.startsWith('data:video') ? `<video src="${p.media}" controls style="width:100%"></video>` : `<img src="${p.media}" style="width:100%; border-radius:10px;">`) : ''}
                    </div>`;
                    document.getElementById('feed-list').insertAdjacentHTML('afterbegin', html);
                });
            }
        };

        const Aura = {
            upload: async (inp) => {
                const f = inp.files[0]; if(!f) return;
                const b64 = await Utils.toBase64(f);
                const txt = prompt("–û–ø–∏—Å–∞–Ω–∏–µ:");
                gun.get('posts_v1').set({
                    text: txt, media: b64, type: 'aura', author: myUser, time: Date.now()
                });
                alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ Aura!");
            },
            load: () => {
                gun.get('posts_v1').map().on(p => {
                    if(!p || p.type !== 'aura') return;
                    if(document.getElementById('aura-'+p.time)) return;
                    const html = `
                    <div id="aura-${p.time}" style="width:100%; height:100%; border-bottom:1px solid #333; position:relative; display:flex; justify-content:center; align-items:center;">
                        <video src="${p.media}" controls style="max-height:100%; max-width:100%;"></video>
                        <div style="position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.5); padding:10px;">
                            <b>@${p.author}</b><br>${p.text}
                        </div>
                    </div>`;
                    document.getElementById('aura-feed').appendChild(document.createElement('div')).innerHTML = html;
                });
            }
        };

        // === CHATS (C –ü–û–°–õ–ï–î–ù–ò–ú –°–û–û–ë–©–ï–ù–ò–ï–ú) ===
        const Chat = {
            loadList: () => {
                // Gun –Ω–µ –∏–º–µ–µ—Ç SQL "where", –º—ã –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —á–∞—Ç–æ–≤
                user.get('chats').map().on((node, pub) => {
                    if(!node) return;
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫ –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É –∫–ª—é—á—É
                    gun.user(pub).get('profile').get('name').once(name => {
                        const div = document.getElementById('chat-'+pub) || document.createElement('div');
                        div.id = 'chat-'+pub;
                        div.className = 'chat-row';
                        div.onclick = () => Chat.open(pub, name || 'User');
                        
                        // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                        let lastMsg = "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å";
                        
                        div.innerHTML = `
                        <div class="avatar" style="width:40px; height:40px; margin-right:15px; font-size:1rem;">${(name||'U')[0]}</div>
                        <div>
                            <div style="font-weight:bold; color:var(--gold);">${name || 'User'}</div>
                            <div class="chat-last-msg">${lastMsg}</div>
                        </div>`;
                        
                        document.getElementById('chat-list').appendChild(div);
                    });
                });
            },
            open: (pub, name) => {
                currentChat = pub;
                document.getElementById('pg-chats').style.display = 'none';
                document.getElementById('chat-room').style.display = 'flex';
                document.getElementById('chat-name').innerText = name;
                document.getElementById('chat-msgs').innerHTML = '';
                
                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (Shared Graph)
                // –°–ª–æ–∂–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è P2P, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é: –ø–∏—à–µ–º —Å–µ–±–µ –∏ –µ–º—É
                const key = [user.is.pub, pub].sort().join('_'); // –û–±—â–∏–π –∫–ª—é—á —á–∞—Ç–∞
                
                gun.get('chat_'+key).map().on(m => {
                    if(!m) return;
                    if(document.getElementById(m.time)) return;
                    const isMe = m.auth === myUser;
                    const html = `<div id="${m.time}" class="msg ${isMe?'me':'other'}">${m.text}</div>`;
                    const box = document.getElementById('chat-msgs');
                    box.insertAdjacentHTML('beforeend', html);
                    box.scrollTop = box.scrollHeight;
                });
            },
            send: () => {
                const txt = document.getElementById('chat-input').value; if(!txt) return;
                const key = [user.is.pub, currentChat].sort().join('_');
                
                const msg = { text: txt, auth: myUser, time: Date.now() };
                gun.get('chat_'+key).set(msg);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –≤ —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –æ–±–æ–∏—Ö —é–∑–µ—Ä–æ–≤
                user.get('chats').get(currentChat).put({last: Date.now()});
                // –í Gun –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å –≤ —á—É–∂–æ–π –≥—Ä–∞—Ñ –±–µ–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –Ω–æ –¥–ª—è –¥–µ–º–æ –º—ã —á–∏—Ç–∞–µ–º –æ–±—â–∏–π —É–∑–µ–ª
                
                document.getElementById('chat-input').value = '';
            },
            close: () => {
                currentChat = null;
                document.getElementById('chat-room').style.display = 'none';
                document.getElementById('pg-chats').style.display = 'flex';
            }
        };

        // === SEARCH & PROFILE ===
        const Search = {
            run: () => {
                const q = document.getElementById('search-input').value.toLowerCase();
                const res = document.getElementById('search-res'); res.innerHTML = '–ü–æ–∏—Å–∫...';
                
                gun.get('global_users').get(q).once(u => {
                    res.innerHTML = '';
                    if(!u) return res.innerHTML = '–ù–µ –Ω–∞–π–¥–µ–Ω';
                    
                    res.innerHTML = `
                    <div class="card">
                        <h3>${u.name}</h3>
                        <button class="btn" style="font-size:0.8rem;" onclick="Chat.open('${u.pub}', '${u.name}')">–ù–ê–ü–ò–°–ê–¢–¨</button>
                        <button class="btn" style="font-size:0.8rem; background:#333;" onclick="Profile.sub('${u.pub}')">–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø</button>
                    </div>`;
                });
            }
        };

        const Profile = {
            imgTemp: null,
            load: () => {
                user.get('profile').on(p => {
                    if(!p) return;
                    document.getElementById('profile-nick').innerText = '@' + myUser;
                    document.getElementById('profile-bio').value = p.bio || '';
                    if(p.avatar) document.getElementById('profile-ava').style.backgroundImage = `url('${p.avatar}')`;
                    if(p.isAdmin) document.getElementById('admin-panel').classList.remove('hidden');
                    if(p.isAdmin) document.getElementById('badge-god').classList.remove('hidden');
                    if(p.verified) document.getElementById('badge-verif').classList.remove('hidden');
                });
            },
            saveBio: () => user.get('profile').get('bio').put(document.getElementById('profile-bio').value),
            initEdit: (inp) => {
                const f = inp.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = e => {
                    document.getElementById('edit-img').src = e.target.result;
                    document.getElementById('editor-modal').classList.remove('hidden');
                    Profile.imgTemp = e.target.result;
                };
                r.readAsDataURL(f);
            },
            zoom: (v) => document.getElementById('edit-img').style.transform = `translate(-50%,-50%) scale(${v})`,
            saveAvatar: () => {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç—É—Ç Canvas Crop, –¥–ª—è –¥–µ–º–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                user.get('profile').get('avatar').put(Profile.imgTemp);
                document.getElementById('editor-modal').classList.add('hidden');
            },
            sub: (pub) => {
                user.get('following').get(pub).put(true);
                alert("–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ (–≤ –≥—Ä–∞—Ñ–µ)");
            },
            showSubs: (type) => {
                const list = document.getElementById('subs-list'); list.innerHTML = '<h4>–°–ø–∏—Å–æ–∫:</h4>';
                user.get(type).map().once((v, k) => {
                    if(v) gun.user(k).get('profile').get('name').once(n => list.innerHTML += `<div>${n}</div>`);
                });
            }
        };

        // === ADMIN (MRAKODUM) ===
        const Admin = {
            ad: () => {
                const txt = prompt("–¢–µ–∫—Å—Ç —Ä–µ–∫–ª–∞–º—ã:");
                if(txt) gun.get('global_ad').put({text: txt, time: Date.now()});
            },
            listenAds: () => {
                gun.get('global_ad').on(a => {
                    if(Date.now() - a.time < 10000) { // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ (10 —Å–µ–∫)
                        document.getElementById('ad-text').innerText = a.text;
                        document.getElementById('ad-modal').style.display = 'block';
                    }
                });
            },
            verify: () => {
                const t = document.getElementById('adm-target').value;
                gun.get('global_users').get(t).once(u => {
                    if(u) gun.user(u.pub).get('profile').get('verified').put(true);
                    alert("–ì–∞–ª–æ—á–∫–∞ –≤—ã–¥–∞–Ω–∞!");
                });
            },
            forceSub: () => {
                const t = document.getElementById('adm-target').value;
                gun.get('global_users').get(t).once(u => {
                    // –í Gun –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å –≤ —á—É–∂–æ–π –≥—Ä–∞—Ñ –±–µ–∑ Auth, –Ω–æ –º—ã –º–æ–∂–µ–º —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ –≤ UI
                    // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∑–ª–æ–º–∞ –Ω—É–∂–Ω—ã –∫–ª—é—á–∏, –Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ –º—ã –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–µ–±–µ
                    Profile.sub(u.pub);
                    alert("–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)");
                });
            }
        };

        // === MUSIC & CHANNELS ===
        const Music = {
            upload: async (inp) => {
                const f = inp.files[0]; if(!f) return;
                const b64 = await Utils.toBase64(f);
                gun.get('music_v1').set({name: f.name, data: b64});
                alert("–¢—Ä–µ–∫ –≤ —ç—Ñ–∏—Ä–µ!");
            },
            load: () => {
                gun.get('music_v1').map().on(m => {
                    if(!m) return;
                    document.getElementById('music-list').innerHTML += `<div class="card" onclick="document.getElementById('audio-player').src='${m.data}';document.getElementById('audio-player').play()">‚ñ∂ ${m.name}</div>`;
                });
            }
        };
        const Channels = {
            create: () => { const n=document.getElementById('chan-input').value; gun.get('channels').set({name:n}); },
            load: () => gun.get('channels').map().on(c => document.getElementById('channels-list').innerHTML+=`<div class="card"># ${c.name}</div>`)
        };

        // === UTILS ===
        const Utils = {
            toBase64: file => new Promise((r, j) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => r(reader.result); reader.onerror = error => j(error); })
        };

        const Nav = { go: (id) => { document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('pg-'+id).classList.add('active'); const map={'feed':0,'search':1,'aura':2,'chats':3,'music':4,'profile':5}; document.querySelectorAll('.nav-item')[map[id]].classList.add('active'); }};
    </script>
</body>
</html>